'use strict';

jQuery.Class('OpenStreetMap_Map_Js',{},{container:!1,mapInstance:!1,selectedParams:!1,layerMarkers:!1,markers:!1,cacheMarkers:[],polygonLayer:!1,routeLayer:!1,recordsIds:'',cacheLayerMarkers:{},indirectPointLayer:{},setSelectedParams:function b(a){this.selectedParams=a;},registerMap:function d(a,b){var c=L.map('mapid').setView(a,b);return L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(c),this.mapInstance=c,c},setMarkersByResponse:function r(a){var b=this,c=[],d=this.container,e=this.mapInstance;if('undefined'!=typeof a.result.coordinates){var f=L.markerClusterGroup({maxClusterRadius:10}),g=a.result.coordinates;'boolean'!=typeof this.layerMarkers&&e.removeLayer(this.layerMarkers);var h=[];g.forEach(function(a){c.push([a.lat,a.lon]);var b=L.marker([a.lat,a.lon],{icon:L.AwesomeMarkers.icon({icon:'home',markerColor:'blue',prefix:'fa',iconColor:a.color})}).bindPopup(a.label);f.addLayer(b),h.push(a.recordId);}),this.recordsIds=h,this.markers=g,this.layerMarkers=f,e.addLayer(f);}if('boolean'!=typeof this.polygonLayer&&e.removeLayer(this.polygonLayer),'undefined'!=typeof a.result.coordinatesCeneter)if('undefined'==typeof a.result.coordinatesCeneter.error){var i=d.find('.radius').val();c.push([a.result.coordinatesCeneter.lat,a.result.coordinatesCeneter.lon]);var j='<span class="description">'+d.find('.searchValue').val()+'</span><br /><input type=hidden class="coordinates" data-lon="'+a.result.coordinatesCeneter.lon+'" data-lat="'+a.result.coordinatesCeneter.lat+'">';j+='<button class="btn btn-success btn-sm p-1 startTrack mr-2"><span class="fas  fa-truck"></span></button>',j+='<button class="btn btn-danger btn-sm p-1 endTrack"><span class="fas fa-flag-checkered"></span></button>';var k=L.marker([a.result.coordinatesCeneter.lat,a.result.coordinatesCeneter.lon],{icon:L.AwesomeMarkers.icon({icon:'search',markerColor:'red',prefix:'fa'})}).bindPopup(j);if(e.addLayer(k),$.isNumeric(i)){i=1e3*parseInt(i);var l=L.circle([a.result.coordinatesCeneter.lat,a.result.coordinatesCeneter.lon],i,{color:'red',fillColor:'#f03',fillOpacity:.05});this.polygonLayer=L.featureGroup([l]),e.addLayer(this.polygonLayer);}}else{var m={title:app.vtranslate('JS_LBL_PERMISSION'),text:a.result.coordinatesCeneter.error,type:'error'};Vtiger_Helper_Js.showMessage(m);}if('undefined'!=typeof a.result.cache){var n=a.result.cache;Object.keys(n).forEach(function(a){'undefined'!=typeof b.cacheLayerMarkers[a]&&e.removeLayer(b.cacheLayerMarkers[a]);var d=L.markerClusterGroup({maxClusterRadius:10});g=n[a],g.forEach(function(a){if(-1===b.recordsIds.indexOf(a.recordId)){c.push([a.lat,a.lon]);var e=L.marker([a.lat,a.lon],{icon:L.AwesomeMarkers.icon({icon:'home',markerColor:'orange',prefix:'fa',iconColor:a.color})}).bindPopup(a.label);d.addLayer(e);}}),b.cacheMarkers[a]=g,e.addLayer(d),b.cacheLayerMarkers[a]=d;});}var o=this.container.find('.modal-footer');if('undefined'!=typeof a.result.legend){var p='',q=a.result.legend;q.forEach(function(a){p+='<div class="pull-left"><span class="leegendIcon" style="background:'+a.color+'"></span> '+a.value+'</div>';}),o.html(p);}else o.html('');c.length&&e.fitBounds(c),this.container.find('.groupNeighbours').prop('checked',!0);},showCalculateBtn:function d(){var a=this.container,b=a.find('.end').val(),c=a.find('.start').val();0<b.length&&0<c.length&&a.find('.calculateTrack').removeClass('d-none');},registerCacheEvents:function c(a){var b=this;a.find('.showRecordsFromCache').on('change',function(a){var c=$(a.currentTarget),d=c.data('module');if(c.is(':checked')){var e={module:'OpenStreetMap',action:'GetMarkers',srcModule:app.getModuleName(),cache:[d]};AppConnector.request(e).done(function(a){b.setMarkersByResponse(a);});}else b.mapInstance.removeLayer(b.cacheLayerMarkers[d]);}),a.find('.copyToClipboard').on('click',function(){var c={module:'OpenStreetMap',action:'ClipBoard',mode:'save',recordIds:JSON.stringify(b.recordsIds),srcModule:app.getModuleName()};AppConnector.request(c).done(function(b){Vtiger_Helper_Js.showMessage({title:app.vtranslate('JS_LBL_PERMISSION'),text:app.vtranslate('JS_NOTIFY_COPY_TEXT'),type:'success'});var c=a.find('.countRecords'+app.getModuleName());c.html(b.result),c.closest('.cacheModuleContainer').find('.deleteClipBoard').removeClass('d-none');});}),a.find('.deleteClipBoard').on('click',function(b){var c=$(b.currentTarget),d=c.data('module');AppConnector.request({module:'OpenStreetMap',action:'ClipBoard',mode:'delete',srcModule:d}).done(function(){Vtiger_Helper_Js.showMessage({title:app.vtranslate('JS_LBL_PERMISSION'),text:app.vtranslate('JS_SAVE_NOTIFY_OK'),type:'success'});var b=a.find('.countRecords'+d);b.html(''),c.addClass('d-none'),b.closest('.cacheModuleContainer').find('.showRecordsFromCache').prop('checked',!1),b.closest('.cacheModuleContainer').find('.showRecordsFromCache').trigger('change');});}),a.find('.addAllRecords').on('click',function(b){var c=$(b.currentTarget),d=c.data('module');AppConnector.request({module:'OpenStreetMap',action:'ClipBoard',mode:'addAllRecords',srcModule:d}).done(function(b){Vtiger_Helper_Js.showMessage({title:app.vtranslate('JS_LBL_PERMISSION'),text:app.vtranslate('JS_SAVE_NOTIFY_OK'),type:'success'}),a.find('.countRecords'+d).html(b.result.count);var e=c.closest('.cacheModuleContainer');e.find('.showRecordsFromCache').prop('checked',!0),e.find('.showRecordsFromCache').trigger('change'),'0'!=b.result.count&&e.find('.deleteClipBoard').removeClass('d-none');});});},getCacheParamsToRequest:function c(){var a=this.container,b=[];return a.find('.showRecordsFromCache').each(function(){var a=$(this);a.is(':checked')&&b.push(a.data('module'));}),b},registerSearchCompany:function f(){var a=this.container,b=a.find('.searchCompany'),c=a.find('.searchModule'),d=a.find('.addRecord'),e=this;d.on('click',function(){var a=e.mapInstance,f=e.layerMarkers,g=d.data('crmId');return ''!=g&&void AppConnector.request({module:'OpenStreetMap',action:'ClipBoard',mode:'addRecord',record:g,srcModuleName:c.val()}).done(function(c){if(d.data('crmId',''),1==c.result.length){var e=L.marker([c.result[0].lat,c.result[0].lon],{icon:L.AwesomeMarkers.icon({icon:'home',markerColor:'cadetblue',prefix:'fa',iconColor:c.result[0].color})}).bindPopup(c.result[0].label);f.addLayer(e),a.addLayer(f),a.setView(new L.LatLng(c.result[0].lat,c.result[0].lon),14);}else Vtiger_Helper_Js.showMessage({title:app.vtranslate('JS_LBL_PERMISSION'),text:c.result,type:'error'});b.val('');})}),$.widget('custom.ivAutocomplete',$.ui.autocomplete,{_create:function a(){this._super(),this.widget().menu('option','items','> :not(.ui-autocomplete-category)');},_renderMenu:function e(a,b){var c=this,d='';$.each(b,function(b,e){e.category!=d&&(a.append('<li class=\'ui-autocomplete-category\'>'+e.category+'</li>'),d=e.category),c._renderItemData(a,e);});},_renderItemData:function c(a,b){return this._renderItem(a,b).data('ui-autocomplete-item',b)},_renderItem:function c(a,b){return $('<li>').data('item.autocomplete',b).append($('<a></a>').html(b.label)).appendTo(a)}}),b.ivAutocomplete({delay:'600',minLength:'3',source:function e(a,d){AppConnector.request({module:c.val(),curentModule:app.getModuleName(),searchModule:c.val(),view:'BasicAjax',mode:'showSearchResults',value:b.val(),html:!1}).done(function(a){a=JSON.parse(a);var b=a.result;0>=b.length&&b.push({label:app.vtranslate('JS_NO_RESULTS_FOUND'),type:'no results',category:''}),d(b);});},select:function e(a,b){var c=b.item;d.data('crmId',c.id);},close:function a(){}});},registerBasicModal:function e(){var a,b,c=this,d=this.container,f=c.mapInstance;c.registerCacheEvents(d),d.find('.groupBy').on('click',function(){var a=jQuery.progressIndicator({position:d,blockInfo:{enabled:!0}}),b={module:'OpenStreetMap',action:'GetMarkers',srcModule:app.getModuleName(),groupBy:d.find('.fieldsToGroup').val(),searchValue:d.find('.searchValue').val(),radius:d.find('.radius').val(),cache:c.getCacheParamsToRequest()};$.extend(b,c.selectedParams),AppConnector.request(b).done(function(b){a.progressIndicator({mode:'hide'}),c.setMarkersByResponse(b);});}),d.find('.groupNeighbours').on('change',function(b){var d=$(b.currentTarget);f.removeLayer(c.layerMarkers);var e=c.markers;if(d.is(':checked'))a=L.markerClusterGroup({maxClusterRadius:10}),e.forEach(function(b){var c=L.marker([b.lat,b.lon],{icon:L.AwesomeMarkers.icon({icon:'home',markerColor:'blue',prefix:'fa',iconColor:b.color})}).bindPopup(b.label);a.addLayer(c);}),Object.keys(c.cacheLayerMarkers).forEach(function(a){f.removeLayer(c.cacheLayerMarkers[a]);var b=L.markerClusterGroup({maxClusterRadius:10});c.cacheMarkers[a].forEach(function(a){var c=L.marker([a.lat,a.lon],{icon:L.AwesomeMarkers.icon({icon:'home',markerColor:'orange',prefix:'fa',iconColor:a.color})}).bindPopup(a.label);b.addLayer(c);}),c.cacheLayerMarkers[a]=b,f.addLayer(b);});else{var g=[];e.forEach(function(a){var b=L.marker([a.lat,a.lon],{icon:L.AwesomeMarkers.icon({icon:'home',markerColor:'blue',prefix:'fa',iconColor:a.color})}).bindPopup(a.label);g.push(b);}),a=L.featureGroup(g),Object.keys(c.cacheLayerMarkers).forEach(function(a){f.removeLayer(c.cacheLayerMarkers[a]);var b=[];c.cacheMarkers[a].forEach(function(a){var c=L.marker([a.lat,a.lon],{icon:L.AwesomeMarkers.icon({icon:'home',markerColor:'orange',prefix:'fa',iconColor:a.color})}).bindPopup(a.label);b.push(c);}),c.cacheLayerMarkers[a]=L.featureGroup(b),f.addLayer(c.cacheLayerMarkers[a]);});}c.layerMarkers=a,f.addLayer(a);}),d.find('.searchBtn').on('click',function(){var a=jQuery.progressIndicator({position:d,blockInfo:{enabled:!0}}),b={module:'OpenStreetMap',action:'GetMarkers',srcModule:app.getModuleName(),searchValue:d.find('.searchValue').val(),cache:c.getCacheParamsToRequest()},e=d.find('.radius').val();''!==e&&parseInt(e)&&(b.radius=e),$.extend(b,c.selectedParams),AppConnector.request(b).done(function(b){a.progressIndicator({mode:'hide'}),c.setMarkersByResponse(b);});});var g=!1;d.on('click','.startTrack',function(a){f.removeLayer(g);var e=$(a.currentTarget),h=e.closest('.leaflet-popup-content');b=h.find('.description').html();var i=d.find('.start'),j=h.find('.coordinates');b=b.replace(/\<br\>/gi,', '),i.val(b),i.data('lat',j.data('lat')),i.data('lon',j.data('lon'));var k=L.marker([j.data('lat'),j.data('lon')],{icon:L.AwesomeMarkers.icon({icon:'truck',markerColor:'green',prefix:'fa'})}).bindPopup(h.html());g=L.featureGroup([k]),f.addLayer(g),c.showCalculateBtn();});var h=!1;d.on('click','.endTrack',function(a){f.removeLayer(h);var e=$(a.currentTarget),g=e.closest('.leaflet-popup-content');b=g.find('.description').html();var i=d.find('.end'),j=g.find('.coordinates');b=b.replace(/\<br\>/gi,', '),i.val(b),i.data('lat',j.data('lat')),i.data('lon',j.data('lon'));var k=L.marker([j.data('lat'),j.data('lon')],{icon:L.AwesomeMarkers.icon({icon:'flag-checkered',markerColor:'red',prefix:'fa'})}).bindPopup(g.html());h=L.featureGroup([k]),f.addLayer(h),c.showCalculateBtn();}),d.on('click','.indirectPoint',function(a){var e=$(a.currentTarget),g=e.closest('.leaflet-popup-content');b=g.find('.description').html();var h=d.find('.indirectTemplate'),i=h.clone();h.before(i),i.removeClass('indirectTemplate'),i.removeClass('d-none');var j=g.find('.coordinates');b=b.replace(/\<br\>/gi,', '),'undefined'!=typeof c.indirectPointLayer[b]&&f.removeLayer(c.indirectPointLayer[b]);var k=i.find('.indirect');k.val(b),k.data('lat',j.data('lat')),k.data('lon',j.data('lon'));var l=L.marker([j.data('lat'),j.data('lon')],{icon:L.AwesomeMarkers.icon({icon:'flag',markerColor:'orange',prefix:'fa'})}).bindPopup(g.html());c.indirectPointLayer[b]=L.featureGroup([l]),f.addLayer(c.indirectPointLayer[b]);}),d.on('click','.removeIndirect',function(a){var b=$(a.currentTarget),d=b.closest('.indirectContainer');f.removeLayer(c.indirectPointLayer[d.find('.indirect').val()]),b.closest('.indirectContainer').remove();}),d.on('click','.moveUp',function(a){var b=$(a.currentTarget),c=b.closest('.indirectContainer'),d=c.prev();d.hasClass('startContainer')||d.before(c);}),d.on('click','.moveDown',function(a){var b=$(a.currentTarget),c=b.closest('.indirectContainer'),d=c.next();d.hasClass('indirectTemplate')||d.after(c);}),d.on('click','.searchInRadius',function(a){f.removeLayer(h);var b=$(a.currentTarget),e=b.closest('.leaflet-popup-content'),g=e.find('.coordinates'),i=jQuery.progressIndicator({position:d,blockInfo:{enabled:!0}}),j={module:'OpenStreetMap',action:'GetMarkers',srcModule:app.getModuleName(),radius:d.find('.radius').val(),lat:g.data('lat'),lon:g.data('lon'),cache:c.getCacheParamsToRequest()};$.extend(j,c.selectedParams),AppConnector.request(j).done(function(a){i.progressIndicator({mode:'hide'}),c.setMarkersByResponse(a);});}),d.find('.calculateTrack').on('click',function(){var a=[],b=[];d.find('.indirectContainer:not(.d-none) input.indirect').each(function(){var c=$(this);b.push(c.data('lat')),a.push(c.data('lon'));});var e=d.find('.end'),g=d.find('.start'),h=jQuery.progressIndicator({position:d,blockInfo:{enabled:!0}}),i={url:'index.php',data:{module:'OpenStreetMap',action:'GetRoute',flon:g.data('lon'),flat:g.data('lat'),ilon:a,ilat:b,tlon:e.data('lon'),tlat:e.data('lat')}};AppConnector.request(i).done(function(a){h.progressIndicator({mode:'hide'}),f.removeLayer(c.routeLayer);var b=L.geoJson(a.result);c.routeLayer=L.featureGroup([b]),f.addLayer(c.routeLayer),d.find('.descriptionContainer').removeClass('d-none'),d.find('.descriptionContent .instruction').html(a.result.properties.description),d.find('.descriptionContent .distance').html(app.parseNumberToShow(a.result.properties.distance)),d.find('.descriptionContent .travelTime').html(app.parseNumberToShow(a.result.properties.traveltime/60));});}),d.find('.setView').on('click',function(a){var b=$(a.currentTarget),c=b.closest('.input-group').find('.end,.start'),d=c.data('lat'),e=c.data('lon');'undefined'==typeof d&&'undefined'==typeof e||f.setView(new L.LatLng(d,e),14);}),this.registerSearchCompany();},registerModalView:function f(a){var b=this,c=jQuery.progressIndicator({position:a,blockInfo:{enabled:!0}}),d=$('body').height();this.container=a;$('#mapid').css({height:d-200}),this.registerMap([0,0],2);var e={module:'OpenStreetMap',action:'GetMarkers',srcModule:app.getModuleName()};$.extend(e,this.selectedParams),b.registerBasicModal(),AppConnector.request(e).done(function(a){c.progressIndicator({mode:'hide'}),b.setMarkersByResponse(a);});},registerDetailView:function h(a){this.container=a;var b=a.find('#coordinates').val();b=JSON.parse(b);var c=[0,0],d=2,e=a.find('#mapid');b.length&&(c=b[0],d=6),$('.mainBody').length?1e3>$('.mainBody').height()?e.height($('.mainBody').height()-($('.detailViewTitle').height()+$('.detailViewContainer .related').height()+25)):e.height(1e3):1e3>$('.bodyContents').height()?e.height($('.bodyContents').height()-($('.detailViewTitle').height()+$('.detailViewContainer .related').height()+25)):e.height(1e3);var f=this.registerMap(c,d),g=L.markerClusterGroup({maxClusterRadius:10});b.forEach(function(a){var b=L.marker([a.lat,a.lon],{icon:L.AwesomeMarkers.icon({icon:'home',markerColor:'blue',prefix:'fa',iconColor:a.color})}).bindPopup(a.label);g.addLayer(b);}),f.addLayer(g);}});
//# sourceMappingURL=Map.min.js.map
