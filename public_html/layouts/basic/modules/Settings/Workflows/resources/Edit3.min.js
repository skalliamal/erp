'use strict';

Settings_Workflows_Edit_Js("Settings_Workflows_Edit3_Js",{},{step3Container:!1,advanceFilterInstance:!1,ckEditorInstance:!1,fieldValueMap:!1,init:function a(){this.initialize();},getContainer:function a(){return this.step3Container},setContainer:function b(a){return this.step3Container=a,this},initialize:function b(a){"undefined"==typeof a&&(a=$("#workflow_step3")),a.is("#workflow_step3")?this.setContainer(a):this.setContainer($("#workflow_step3"));},registerEditTaskEvent:function c(){var a=this,b=this.getContainer();b.on("click","[data-url]",function(c){var d=$(c.currentTarget),e=d.data("url"),f=$.progressIndicator({position:"html",blockInfo:{enabled:!0}});app.showModalWindow(null,e,function(c){if(f.progressIndicator({mode:"hide"}),c){var g=App.Fields.Text.registerCopyClipboard(c);b.one("hidden.bs.modal",function(){g.destroy();});}a.registerVTCreateTodoTaskEvents();var d=$("#taskType").val(),e="register"+d+"Events";"undefined"!=typeof a[e]&&a[e].apply(a),a.registerSaveTaskSubmitEvent(d),$("#saveTask").validationEngine(app.validationEngineOptions),a.registerFillTaskFieldsEvent(),a.registerCheckSelectDateEvent(),app.showPopoverElementView($(c).find(".js-popover-tooltip"));});});},registerCheckSelectDateEvent:function a(){$("[name=\"check_select_date\"]").on("change",function(a){$(a.currentTarget).is(":checked")?$("#checkSelectDateContainer").removeClass("d-none").addClass("show"):$("#checkSelectDateContainer").removeClass("show").addClass("d-none");});},registerSaveTaskSubmitEvent:function c(a){var b=this;$("#saveTask").on("submit",function(c){var d=$(c.currentTarget),e=d.validationEngine("validate");if(!0==e){var f=a+"CustomValidation";if("undefined"!=typeof b[f]){var g=b[f].apply(b);if(!0!=g){var h={title:app.vtranslate("JS_MESSAGE"),text:g,type:"error"};return Vtiger_Helper_Js.showPnotify(h),void c.preventDefault()}}var i="preSave"+a;"undefined"!=typeof b[i]&&b[i].apply(b,[a]);var h=d.serializeFormData();AppConnector.request(h).done(function(a){a.result&&(b.getTaskList(),app.hideModalWindow());});}c.preventDefault();});},VTUpdateFieldsTaskCustomValidation:function a(){return this.checkDuplicateFieldsSelected()},VTCreateEntityTaskCustomValidation:function a(){return this.checkDuplicateFieldsSelected()},checkDuplicateFieldsSelected:function d(){var a=$("#save_fieldvaluemapping").find(".js-conditions-row").find("[name=\"fieldname\"]"),b=!0,c=app.vtranslate("JS_SAME_FIELDS_SELECTED_MORE_THAN_ONCE");return $.each(a,function(a,d){var e=$(d).attr("value"),f=$("[name="+e+"]").not(":hidden");if(1<f.length)return b=c,!1}),b},preSaveVTUpdateFieldsTask:function c(a){var b=this.getValues(a);$("[name=\"field_value_mapping\"]").val(JSON.stringify(b));},preSaveVTCreateEntityTask:function c(a){var b=this.getValues(a);$("[name=\"field_value_mapping\"]").val(JSON.stringify(b));},preSaveVTEmailTask:function b(){var a=$("#content");a.val(CKEDITOR.instances.content.getData());},preSaveVTUpdateRelatedFieldTask:function c(a){var b=this.getValues(a);$("[name=\"field_value_mapping\"]").val(JSON.stringify(b));},isEmptyFieldSelected:function c(a){var b=a.find("option:selected");return !("none"!=b.val())},getVTCreateEntityTaskFieldList:function a(){return new Array("fieldname","value","valuetype","modulename")},getVTUpdateFieldsTaskFieldList:function a(){return new Array("fieldname","value","valuetype")},getVTUpdateRelatedFieldTaskFieldList:function a(){return new Array("fieldname","value","valuetype")},getValues:function h(a){var b=this,c=$("#save_fieldvaluemapping"),d="get"+a+"FieldList";if("undefined"!=typeof b[d])var e=b[d].apply();var f=[],g=$(".js-conditions-row",c);return g.each(function(a,c){var d=$(c),g=$("[name=\"fieldname\"]",d),h=$("[data-value=\"value\"]",d);if(b.isEmptyFieldSelected(g))return !0;var j=g.find("option:selected").data("fieldinfo"),k=j.type,l={};if("owner"==k)for(var m in e){var n=e[m];l[n]="value"==n&&h.is("select")?h.find("option:selected").val():$("[name=\""+n+"\"]",d).val();}else if("picklist"==k||"multipicklist"==k)for(var m in e){var n=e[m];if("value"==n&&h.is("input")){var o=h.val(),p=h.data("picklistvalues"),q=o.split(","),r=[];for(a=0;a<q.length;a++)"undefined"==typeof p[q[a]]?r.push(q[a]):r.push(p[q[a]]);var s=r.join(",");l[n]=s;}else if("value"==n&&h.is("select")&&"picklist"==k)l[n]=h.val();else if("value"==n&&h.is("select")&&"multipicklist"==k){var t=h.val();l[n]=null==t?t:t.join(",");}else l[n]=$("[name=\""+n+"\"]",d).val();}else for(var m in e){var n=e[m];l[n]="value"==n?h.val():$("[name=\""+n+"\"]",d).val();}("false"==$("[name=\"valuetype\"]",d).val()||0==$("[name=\"valuetype\"]",d).length)&&(l.valuetype="rawtext"),f.push(l);}),f},getTaskList:function d(){var a=this.getContainer(),b={module:app.getModuleName(),parent:app.getParentModuleName(),view:"TasksList",record:$("[name=\"record\"]",a).val()},c=$.progressIndicator({position:"html",blockInfo:{enabled:!0}});AppConnector.request(b).done(function(a){$("#taskListContainer").html(a),c.progressIndicator({mode:"hide"});});},getckEditorInstance:function a(){return !1===this.ckEditorInstance&&(this.ckEditorInstance=new App.Fields.Text.Editor),this.ckEditorInstance},registerTaskStatusChangeEvent:function b(){var a=this.getContainer();a.on("change",".taskStatus",function(a){var b=$(a.currentTarget),c=b.data("statusurl");c+=b.is(":checked")?"&status=true":"&status=false";var d=$.progressIndicator({position:"html",blockInfo:{enabled:!0}});AppConnector.request(c).done(function(a){if("ok"==a.result){var b={title:app.vtranslate("JS_MESSAGE"),text:app.vtranslate("JS_STATUS_CHANGED_SUCCESSFULLY"),type:"success"};Vtiger_Helper_Js.showPnotify(b);}d.progressIndicator({mode:"hide"});}),a.stopImmediatePropagation();});},registerTaskDeleteEvent:function c(){var a=this,b=this.getContainer();b.on("click",".deleteTask",function(b){var c=app.vtranslate("LBL_DELETE_CONFIRMATION");Vtiger_Helper_Js.showConfirmationBox({message:c}).done(function(){var c=$(b.currentTarget),d=c.data("deleteurl");AppConnector.request(d).done(function(b){if("ok"==b.result){a.getTaskList();var c={title:app.vtranslate("JS_MESSAGE"),text:app.vtranslate("JS_TASK_DELETED_SUCCESSFULLY"),type:"success"};Vtiger_Helper_Js.showPnotify(c);}});});});},registerFillTaskFromEmailFieldEvent:function a(){$("#saveTask").on("change","#fromEmailOption",function(a){var b=$(a.currentTarget),c=b.closest(".row").find(".fields");c.val(b.val());});},registerFillTaskFieldsEvent:function a(){$("#saveTask").on("change",".task-fields",function(a){var b=$(a.currentTarget),c=b.closest(".row").find(".fields"),d=c.val(),e=d+b.val();c.val(e);});},registerFillMailContentEvent:function a(){$("#task-fieldnames,#task_timefields,#task-templates").on("change",function(a){var b=CKEDITOR.instances.content,c=$(a.currentTarget).val();if(b!=null)b.insertHtml(c);else if($("textarea[name=\"content\"]")){var d=$("textarea[name=\"content\"]");d.insertAtCaret(c);}});},registerVTEmailTaskEvents:function c(){var a=$("#content"),b=this.getckEditorInstance();b.loadEditor(a),this.registerFillMailContentEvent(),this.registerFillTaskFromEmailFieldEvent(),this.registerCcAndBccEvents();},registerVTCreateTodoTaskEvents:function a(){app.registerEventForClockPicker();},registerVTUpdateFieldsTaskEvents:function c(){var a=this;this.registerAddFieldEvent(),this.registerDeleteConditionEvent(),this.registerFieldChange(),this.fieldValueMap=!1,""!=$("#fieldValueMapping").val()&&this.fieldValueReMapping();var b=$("#save_fieldvaluemapping").find("select[name=\"fieldname\"]");$.each(b,function(b,c){a.loadFieldSpecificUi($(c));}),this.getPopUp($("#saveTask"));},registerVTUpdateRelatedFieldTaskEvents:function c(){var a=this;this.registerAddFieldEvent(),this.registerDeleteConditionEvent(),this.registerFieldChange(),this.fieldValueMap=!1,""!=$("#fieldValueMapping").val()&&this.fieldValueReMapping();var b=$("#save_fieldvaluemapping").find("select[name=\"fieldname\"]");$.each(b,function(b,c){a.loadFieldSpecificUi($(c));}),this.getPopUp($("#saveTask"));},registerAddFieldEvent:function a(){$("#addFieldBtn").on("click",function(){var a=$(".js-add-basic-field-container").clone(!0,!0).removeClass("js-add-basic-field-container d-none").addClass("js-conditions-row");$("select",a).addClass("select2"),$("#save_fieldvaluemapping").append(a),App.Fields.Picklist.changeSelectElementView(a);});},registerDeleteConditionEvent:function a(){$("#saveTask").on("click",".deleteCondition",function(a){$(a.currentTarget).closest(".js-conditions-row").remove();});},registerFieldChange:function b(){var a=this;$("#saveTask").on("change","select[name=\"fieldname\"]",function(b){var c=$(b.currentTarget);if("none"!=c.val()){var d=c.closest(".js-conditions-row"),e=d.find("[name=\"modulename\"]");if(0<e.length){var f=c.find("option:selected").data("fieldinfo"),g=f.type;if("picklist"==g||"multipicklist"==g){var h=$("select.createEntityModule:not(:disabled)"),i=h.val();e.val(i).change().prop("disabled",!0);}}a.loadFieldSpecificUi(c);}});},getModuleName:function a(){return app.getModuleName()},getFieldValueMapping:function b(){var a=this.fieldValueMap;return !1==a?"":a},fieldValueReMapping:function c(){var a=JSON.parse($("#fieldValueMapping").val()),b={};$.each(a,function(a,c){b[c.fieldname]={};var d={};$.each(c,function(a,b){d[a]=b;}),b[c.fieldname]=d;}),this.fieldValueMap=b;},loadFieldSpecificUi:function n(a){var b=a.find("option:selected"),c=a.closest("div.js-conditions-row"),d=c.find(".fieldUiHolder"),e=b.data("fieldinfo"),f=this.getFieldValueMapping(),g="";f&&"undefined"!=typeof f[e.name]?g=f[e.name]:f&&"undefined"!=typeof f[a.val()]&&(g=f[a.val()]),g?(e.value=g.value,e.workflow_valuetype=g.valuetype):e.workflow_valuetype="rawtext";var h=this.getModuleName(),i=Vtiger_Field_Js.getInstance(e,h);this.fieldModelInstance=i;var j=this.getFieldSpecificUi(a),k=i.getName();"multipicklist"==i.getType()&&(k+="[]"),j.filter("[name=\""+k+"\"]").attr("data-value","value"),j.find("[name=\""+k+"\"]").attr("data-value","value"),j.filter("[name=\"valuetype\"]").removeAttr("data-validation-engine"),j.find("[name=\"valuetype\"]").removeAttr("data-validation-engine");var l=j.filter("[name=\"valuetype\"]").val();if("rawtext"!=l&&"undefined"!=typeof l&&(j.filter("[name=\""+k+"\"]").removeAttr("data-validation-engine"),j.find("[name=\""+k+"\"]").removeAttr("data-validation-engine")),d.html(j),j.is("input.select2")){var m=j.data("tags");App.Fields.Picklist.showSelect2ElementView(j,{tags:m,tokenSeparators:[","]});}else j.is("select")?j.hasClass("chzn-select")?App.Fields.Picklist.showChoosenElementView(j):App.Fields.Picklist.showSelect2ElementView(j):j.is("input.dateField")?App.Fields.Date.register(j):j.is("input.dateRangeField")&&App.Fields.Date.registerRange(j,{ranges:!1});return this},getFieldSpecificUi:function b(){var a=this.fieldModelInstance;return $(a.getUiTypeSpecificHtml())},registerVTCreateEventTaskEvents:function a(){app.registerEventForClockPicker();},registerVTCreateEntityTaskEvents:function a(){this.registerChangeCreateEntityEvent(),this.registerVTUpdateFieldsTaskEvents();},registerChangeCreateEntityEvent:function b(){var a=this;$("[name=\"mappingPanel\"]").on("change",function(a){var b=$(a.currentTarget);app.setMainParams("mappingPanel",b.val()),$("#addCreateEntityContainer").html("");var c=$("."+b.data("hide")),d=$("."+b.data("show")),e=app.getMainParams("taskFields",!0);c.addClass("d-none").find("input,select").each(function(){var a=$(this),b=a.attr("name");0<=$.inArray(b,e)&&(a.is("select")&&a.val("").trigger("chosen:updated").change(),a.prop("disabled",!0));}),d.removeClass("d-none").find("input,select").each(function(){var a=$(this),b=a.attr("name");0<=$.inArray(b,e)&&(a.prop("disabled",!1),a.is("select")&&a.val("").trigger("chosen:updated").change());});}),$(".createEntityModule").on("change",function(b){var c={module:app.getModuleName(),parent:app.getParentModuleName(),view:"CreateEntity",for_workflow:$("[name=\"for_workflow\"]").val(),mappingPanel:app.getMainParams("mappingPanel")},d=$(b.currentTarget).val();d&&(c.relatedModule=d);var e=$.progressIndicator({position:"html",blockInfo:{enabled:!0}});AppConnector.request(c).done(function(b){e.progressIndicator({mode:"hide"});var c=$("#addCreateEntityContainer");c.html(b),App.Fields.Picklist.changeSelectElementView(c),App.Fields.Picklist.showSelect2ElementView(c.find(".select2")),a.registerAddFieldEvent(),a.fieldValueMap=!1,""!=$("#fieldValueMapping").val()&&this.fieldValueReMapping();var d=$("#save_fieldvaluemapping").find("select[name=\"fieldname\"]");$.each(d,function(b,c){a.loadFieldSpecificUi($(c));});});});},changeRecurringTypesUIStyles:function b(a){"Daily"==a||"Yearly"==a?($("#repeatWeekUI").removeClass("show").addClass("d-none"),$("#repeatMonthUI").removeClass("show").addClass("d-none")):"Weekly"==a?($("#repeatWeekUI").removeClass("d-none").addClass("show"),$("#repeatMonthUI").removeClass("show").addClass("d-none")):"Monthly"==a&&($("#repeatWeekUI").removeClass("show").addClass("d-none"),$("#repeatMonthUI").removeClass("d-none").addClass("show"));},checkHiddenStatusofCcandBcc:function c(){var a=$("#ccLink"),b=$("#bccLink");a.hasClass("d-none")&&b.hasClass("d-none")&&a.closest("div.row").addClass("d-none");},registerCcAndBccEvents:function b(){var a=this;$("#ccLink").on("click",function(b){var c=$("#ccContainer");c.removeClass("d-none");var d=c.find("select.task-fields");d.addClass("chzn-select"),App.Fields.Picklist.changeSelectElementView(d),$(b.currentTarget).addClass("d-none"),a.checkHiddenStatusofCcandBcc();}),$("#bccLink").on("click",function(b){var c=$("#bccContainer");c.removeClass("d-none");var d=c.find("select.task-fields");d.addClass("chzn-select"),App.Fields.Picklist.changeSelectElementView(d),$(b.currentTarget).addClass("d-none"),a.checkHiddenStatusofCcandBcc();});},registerEvents:function b(){var a=this.getContainer();App.Fields.Picklist.changeSelectElementView(a),this.registerEditTaskEvent(),this.registerTaskStatusChangeEvent(),this.registerTaskDeleteEvent();}}),$.fn.extend({insertAtCaret:function b(a){return this.each(function(){if(document.selection){this.focus();var b=document.selection.createRange();b.text=a,this.focus();}else if(this.selectionStart||"0"==this.selectionStart){var c=this.selectionStart,d=this.selectionEnd,e=this.scrollTop;this.value=this.value.substring(0,c)+a+this.value.substring(d,this.value.length),this.focus(),this.selectionStart=c+a.length,this.selectionEnd=c+a.length,this.scrollTop=e;}else this.value+=a,this.focus();})}});
//# sourceMappingURL=Edit3.min.js.map
