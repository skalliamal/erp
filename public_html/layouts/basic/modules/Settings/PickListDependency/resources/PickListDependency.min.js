'use strict';

jQuery.Class('Settings_PickListDependency_Js',{pickListDependencyInstance:!1,triggerAdd:function c(a){a.stopPropagation();var b=Settings_PickListDependency_Js.pickListDependencyInstance;b.updatedSourceValues=[],b.showEditView(b.listViewForModule).done(function(){b.registerAddViewEvents();});},triggerEdit:function f(a,b,c,d){a.stopPropagation();var e=Settings_PickListDependency_Js.pickListDependencyInstance;e.updatedSourceValues=[],e.showEditView(b,c,d).done(function(){var a=jQuery('#pickListDependencyForm');a.find('select[name="sourceModule"],select[name="sourceField"],select[name="targetField"]').prop('disabled',!0);a.find('.dependencyMapping');e.registerDependencyGraphEvents(),e.registerSubmitEvent();});},triggerDelete:function i(a,b,c,d){a.stopPropagation();var e=jQuery(a.currentTarget),f=e.closest('tr'),g=Settings_PickListDependency_Js.pickListDependencyInstance,h=app.vtranslate('JS_LBL_ARE_YOU_SURE_YOU_WANT_TO_DELETE');Vtiger_Helper_Js.showConfirmationBox({message:h}).done(function(){g.deleteDependency(b,c,d).done(function(){var a={};a.text=app.vtranslate('JS_DEPENDENCY_DELETED_SUEESSFULLY'),Settings_Vtiger_Index_Js.showMessage(a),f.fadeOut('slow').remove();});});}},{init:function a(){Settings_PickListDependency_Js.pickListDependencyInstance=this;},listViewForModule:'',updatedSourceValues:[],valueMapping:[],selectedSourceValues:[],showEditView:function g(a,b,c){var d=jQuery.Deferred(),e=jQuery.progressIndicator({position:'html',blockInfo:{enabled:!0}}),f={};return f.module=app.getModuleName(),f.parent=app.getParentModuleName(),f.view='Edit',f.sourceModule=a,f.sourcefield=b,f.targetfield=c,AppConnector.requestPjax(f).done(function(a){e.progressIndicator({mode:'hide'});var b=jQuery('.contentsDiv');b.html(a),App.Fields.Picklist.showSelect2ElementView(b.find('select.select2'),{dropdownCss:{"z-index":0}}),d.resolve(a);}).fail(function(a){e.progressIndicator({mode:'hide'}),d.reject(a);}),d.promise()},getModuleDependencyGraph:function c(a){var b=this;a.find('[name="sourceModule"]').on('change',function(){var c=a.find('[name="sourceModule"]').val();b.showEditView(c).done(function(){b.registerAddViewEvents();});});},registerPicklistFieldsChangeEvent:function c(a){var b=this;a.find('[name="sourceField"],[name="targetField"]').on('change',function(){b.checkValuesForDependencyGraph(a);});},checkValuesForDependencyGraph:function n(a){var b=this,c=a.find('[name="sourceField"]'),d=a.find('[name="targetField"]'),e=app.getSelect2ElementFromSelect(c),f=app.getSelect2ElementFromSelect(d),g=c.val(),h=d.val(),i=jQuery('#dependencyGraph');if(''!=g&&''!=h){var j=app.vtranslate('JS_SOURCE_AND_TARGET_FIELDS_SHOULD_NOT_BE_SAME');if(a.find('.errorMessage').addClass('d-none'),g==h)f.validationEngine('showPrompt',j,'error','topLeft',!0),i.html('');else{e.validationEngine('hide'),f.validationEngine('hide');var k=a.find('[name="sourceModule"]').val(),l=jQuery.progressIndicator({position:'html',blockInfo:{enabled:!0}});b.checkCyclicDependency(k,g,h).done(function(c){var d=c.result;d.result?(l.progressIndicator({mode:'hide'}),a.find('.errorMessage').removeClass('d-none'),a.find('.cancelAddView').removeClass('d-none'),i.html('')):(b.addNewDependencyPickList(k,g,h),l.progressIndicator({mode:'hide'}));}).fail(function(){l.progressIndicator({mode:'hide'});});}}else{a.find('.errorMessage').addClass('d-none');var m=app.vtranslate('JS_SELECT_SOME_VALUE');''==g?e.validationEngine('showPrompt',m,'error','topLeft',!0):''==h&&f.validationEngine('showPrompt',m,'error','topLeft',!0);}},checkCyclicDependency:function f(a,b,c){var d=jQuery.Deferred(),e={};return e.mode='checkCyclicDependency',e.module=app.getModuleName(),e.parent=app.getParentModuleName(),e.action='Index',e.sourceModule=a,e.sourcefield=b,e.targetfield=c,AppConnector.request(e).done(function(a){d.resolve(a);},function(){d.reject();}),d.promise()},addNewDependencyPickList:function f(a,b,c){var d=this,e=$('#dependencyGraph');d.updatedSourceValues=[],AppConnector.request({mode:'getDependencyGraph',module:app.getModuleName(),parent:app.getParentModuleName(),view:'IndexAjax',sourceModule:a,sourcefield:b,targetfield:c}).done(function(a){e.html(a).css({padding:'10px',border:'1px solid #ddd',background:'#fff'}),d.registerDependencyGraphEvents();});},deleteDependency:function f(a,b,c){var d=jQuery.Deferred(),e={};return e.module=app.getModuleName(),e.parent=app.getParentModuleName(),e.action='DeleteAjax',e.sourceModule=a,e.sourcefield=b,e.targetfield=c,AppConnector.request(e).done(function(a){d.resolve(a);}).fail(function(a,b){d.reject(a,b);}),d.promise()},registerCancelAddView:function d(a){var b=this,c=a.find('.cancelAddView');c.removeClass('d-none'),c.find('.cancelLink').on('click',function(){b.loadListViewContents(b.listViewForModule);});},registerAddViewEvents:function c(){var a=this,b=jQuery('#pickListDependencyForm');a.registerCancelAddView(b),a.getModuleDependencyGraph(b),a.registerPicklistFieldsChangeEvent(b),a.registerSubmitEvent();},registerDependencyGraphEvents:function d(){var a=this,b=jQuery('#pickListDependencyForm'),c=jQuery('#dependencyGraph');b.find('.cancelAddView').addClass('d-none'),a.registerTargetFieldsClickEvent(c),a.registerTargetFieldsUnmarkAll(c),a.registerSelectSourceValuesClick(c),a.registerCancelDependency(b);},registerListViewEvents:function c(){var a=this,b=jQuery('.contentsDiv').find('.pickListSupportedModules').val();a.listViewForModule=b,a.registerSourceModuleChangeEvent();},registerCancelDependency:function d(a){var b=this,c=a.find('.cancelDependency');c.on('click',function(){b.loadListViewContents(b.listViewForModule);});},registerTargetFieldsClickEvent:function c(a){var b=this;b.updatedSourceValues=[],a.find('td.picklistValueMapping').on('click',function(a){var c=jQuery(a.currentTarget),d=c.data('sourceValue');-1==jQuery.inArray(d,b.updatedSourceValues)&&b.updatedSourceValues.push(d),c.hasClass('selectedCell')?c.addClass('unselectedCell').removeClass('selectedCell'):c.addClass('selectedCell').removeClass('unselectedCell');});},registerTargetFieldsUnmarkAll:function c(a){var b=this;b.updatedSourceValues=[],a.find('.unmarkAll').on('click',function(){a.find('td.picklistValueMapping').each(function(){var a=jQuery(this),c=a.data('sourceValue');-1==jQuery.inArray(c,b.updatedSourceValues)&&b.updatedSourceValues.push(c),a.addClass('unselectedCell').removeClass('selectedCell');});});},updateValueMapping:function h(a){var b=this;b.valueMapping=[];var c=b.updatedSourceValues,d=a.find('.pickListDependencyTable');for(var e in c){var i=void 0;i='string'==typeof c[e]?c[e].replace(/"/g,'\\"'):c[e];var f=d.find('td[data-source-value="'+i+'"]').filter('.selectedCell'),g=[];0<f.length?jQuery.each(f,function(a,b){g.push(jQuery(b).data('targetValue'));}):g.push(''),b.valueMapping.push({sourcevalue:c[e],targetvalues:g});}},registerSelectSourceValuesClick:function c(a){var b=this;a.find('button.sourceValues').on('click',function(){var c=a.find('.modalCloneCopy'),d=c.clone(!0,!0).removeClass('modalCloneCopy'),e=function(d){d.find('.sourcePicklistValuesModal').removeClass('d-none'),d.find('[name="saveButton"]').on('click',function(){b.selectedSourceValues=[];var e=d.find('.sourceValue');jQuery.each(e,function(a,d){var e,f=jQuery(d),g=f.val();e='string'==typeof g?g.replace(/"/g,'\\"'):g;var h=c.find('[type="checkbox"].sourceValue.'+e);f.is(':checked')?(b.selectedSourceValues.push(g),h.prop('checked',!0)):h.prop('checked',!1);}),app.hideModalWindow(),b.loadMappingForSelectedValues(a);});};app.showModalWindow(d,function(a){'function'==typeof e&&e(a);},{width:'1000px'});});},loadMappingForSelectedValues:function h(a){var b=this,c=JSON.parse(a.find('.allSourceValues').val()),d=a.find('.pickListDependencyTable');for(var e in c){if('string'==typeof c[e])var f=c[e].replace(/"/g,'\\"');else f=c[e];var g=d.find('[data-source-value="'+f+'"]');-1==jQuery.inArray(c[e],b.selectedSourceValues)?g.hide():g.show();}},savePickListDependency:function e(a){var b=this,c=jQuery.progressIndicator({position:'html',blockInfo:{enabled:!0}}),d=a.serializeFormData();d.module=app.getModuleName(),d.parent=app.getParentModuleName(),d.action='SaveAjax',d.mapping=JSON.stringify(b.valueMapping),AppConnector.request(d).done(function(a){if(a.success){c.progressIndicator({mode:'hide'});var d={};d.text=app.vtranslate('JS_PICKLIST_DEPENDENCY_SAVED'),Settings_Vtiger_Index_Js.showMessage(d),b.loadListViewContents(b.listViewForModule);}}).fail(function(){c.progressIndicator({mode:'hide'});});},loadListViewContents:function e(a){var b=this,c=jQuery.progressIndicator({position:'html',blockInfo:{enabled:!0}}),d={};d.module=app.getModuleName(),d.parent=app.getParentModuleName(),d.view='List',d.formodule=a,AppConnector.requestPjax(d).done(function(a){c.progressIndicator({mode:'hide'}),jQuery('.contentsDiv').html(a),App.Fields.Picklist.changeSelectElementView(jQuery('.contentsDiv').find('.pickListSupportedModules')),b.registerListViewEvents();}).fail(function(){c.progressIndicator({mode:'hide'});});},triggerDisplayTypeEvent:function c(){var a=app.cacheGet('widthType','narrowWidthType');if(a){var b=jQuery('.listViewEntriesTable').find('td,th');b.attr('class',a);}},registerSourceModuleChangeEvent:function c(){var a=this,b=jQuery('.contentsDiv');b.find('.pickListSupportedModules').on('change',function(b){var c=jQuery(b.currentTarget),d=c.val();a.loadListViewContents(d);});},registerSubmitEvent:function d(){var a=this,b=jQuery('#pickListDependencyForm'),c=jQuery('#dependencyGraph');b.on('submit',function(d){d.preventDefault();try{a.updateValueMapping(c);}catch(a){return void bootbox.alert(a.message)}if('true'!=b.find('.editDependency').val()&&1>a.valueMapping.length){var e={};e.text=app.vtranslate('JS_PICKLIST_DEPENDENCY_NO_SAVED'),e.type='info',Settings_Vtiger_Index_Js.showMessage(e);}else a.savePickListDependency(b);});},registerEvents:function c(){var a=this,b=jQuery('#pickListDependencyForm');if(0<b.length){b.find('.dependencyMapping');'true'==b.find('.editDependency').val()?(b.find('select[name="sourceModule"],select[name="sourceField"],select[name="targetField"]').prop('disabled',!0),a.registerDependencyGraphEvents(),a.registerSubmitEvent()):a.registerAddViewEvents();}else a.registerListViewEvents();}}),jQuery(document).ready(function(){var a=new Settings_PickListDependency_Js;a.registerEvents();});
//# sourceMappingURL=PickListDependency.min.js.map
