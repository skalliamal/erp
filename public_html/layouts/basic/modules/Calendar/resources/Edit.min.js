'use strict';

Vtiger_Edit_Js('Calendar_Edit_Js',{},{isEvents:function c(){var a=this.getForm(),b=a.find('[name="module"]').val();return !('Events'!=b)},registerReminderFieldCheckBox:function a(){this.getForm().find('input[name="set_reminder"]').on('change',function(a){var b=jQuery(a.currentTarget),c=b.closest('div').next();b.is(':checked')?c.removeClass('d-none'):c.addClass('d-none');});},registerRecurrenceFieldCheckBox:function d(){var a=this,b=a.getForm();if(b.find('input[name="reapeat"]').on('change',function(a){var c=jQuery(a.currentTarget),d=b.find('.repeatUI'),e=b.find('[name="followup"]').closest('.fieldValue');c.is(':checked')?(d.removeClass('d-none'),e.find('[name="followup_display"]').attr('disabled','disabled'),e.find('button').attr('disabled','disabled')):(e.find('[name="followup_display"]').removeAttr('disabled'),e.find('button').removeAttr('disabled'),d.addClass('d-none'));}),b.find('input[name="reapeat"]').is(':checked')){b.find('.repeatUI').removeClass('d-none');var c=b.find('[name="followup"]').closest('.fieldValue');c.find('[name="followup_display"]').attr('disabled','disabled'),c.find('button').attr('disabled','disabled');}},registerRecurringTypeChangeEvent:function c(){var a=this.getForm(),b=this;a.find('.recurringType').on('change',function(a){b.changeRecurringTypesUIStyles(jQuery(a.currentTarget).val());}),a.find('.repeatUI [name="calendarEndType"]').on('change',function(b){var c=$(b.currentTarget),d=c.val();'never'===d?(a.find('.countEvents').attr('disabled','disabled'),a.find('.calendarUntil').attr('disabled','disabled')):'count'===d?(a.find('.countEvents').removeAttr('disabled'),a.find('.calendarUntil').attr('disabled','disabled')):'until'===d&&(a.find('.countEvents').attr('disabled','disabled'),a.find('.calendarUntil').removeAttr('disabled'));});},changeRecurringTypesUIStyles:function c(a){var b=this.getForm();'DAILY'==a||'YEARLY'==a?(b.find('.repeatWeekUI').removeClass('show').addClass('d-none'),b.find('.repeatMonthUI').removeClass('show').addClass('d-none')):'WEEKLY'==a?(b.find('.repeatWeekUI').removeClass('d-none').addClass('show'),b.find('.repeatMonthUI').removeClass('show').addClass('d-none')):'MONTHLY'==a&&(b.find('.repeatWeekUI').removeClass('show').addClass('d-none'),b.find('.repeatMonthUI').removeClass('d-none').addClass('show'));},setDefaultEndTime:function n(a){var b=a.find('[name="date_start"]'),c=a.find('[name="time_start"]'),d=a.find('[name="time_end"]'),e=a.find('[name="due_date"]');if('1'!=jQuery('[name="userChangedEndDateTime"]').val()){var f=b.val(),g=c.val(),h=Vtiger_Time_Validator_Js.invokeValidation(c);if(!0==h){var i=f+' '+g,j=a.find('[name="due_date"]').data('dateFormat').toUpperCase(),k=d.data('format'),l='';if(l='Call'==a.find('[name="activitytype"]').val()?moment(i,j).add(a.find('[name="defaultCallDuration"]').val(),'minutes').format(j):moment(i,j).add(a.find('[name="defaultOtherEventDuration"]').val(),'minutes').format(j),24==k)var m='HH:mm';else m='hh:mm A';e.val(l),d.val(moment(g,m).add(a.find('[name="defaultOtherEventDuration"]').val(),'minutes').format(m));}}},registerActivityTypeChangeEvent:function c(a){var b=this;a.on('change','select[name="activitytype"]',function(){b.setDefaultEndTime(a);});},registerTimeStartChangeEvent:function c(a){var b=this;a.find('input[name="time_start"]').on('change',function(){b.setDefaultEndTime(a);}),a.find('[name="date_start"]').on('change',function(c){var d=jQuery(c.currentTarget),e=a.find('[name="due_date"]'),f=b.getDateInstance(a,'start'),g=b.getDateInstance(a,'end'),h=CONFIG.dateFormat.toUpperCase();a.find('.autofill:visible').trigger('change'),f>g&&(g=f,e.val(moment(g).format(h)),App.Fields.Date.register(a));var i=d.closest('.fieldValue').find('[name="time_start"]');i.trigger('changeTime');}),a.find('input[name="time_start"]').on('focus',function(a){var b=jQuery(a.currentTarget);b.data('prevValue',b.val());}),a.find('input[name="time_start"]').on('blur',function(a,b){'undefined'==typeof b&&(b={}),'undefined'==typeof b.forceChange&&(b.forceChange=!1);var c=jQuery(a.currentTarget),d=c.val(),f=c.data('prevValue');(d!=f||b.forceChange)&&(a=jQuery.Event('keydown'),a.which=13,a.keyCode=13,c.trigger(a));});},registerEndDateTimeChangeLogger:function b(a){a.find('[name="time_end"]').on('change',function(a){var b=jQuery(a.currentTarget),c=Vtiger_Time_Validator_Js.invokeValidation(b);if(!0==c){var d=b.closest('.fieldValue').find('[name="due_date"]');jQuery('[name="userChangedEndDateTime"]').val('1'),d.data('userChangedTime',!0);}}),a.find('[name="due_date"]').on('change',function(a){var b=jQuery(a.currentTarget),c=Vtiger_Date_Validator_Js.invokeValidation(b);!0!=c||(jQuery('[name="userChangedEndDateTime"]').val('1'),b.data('userChangedTime',!0));});},getRule:function l(){var a=this.getForm(),b=a.find('.recurringType').val(),c='FREQ='+b;c+=';INTERVAL='+a.find('.repeatFrequency').val();var d=a.find('.repeatUI [name="calendarEndType"]:checked').val();if('count'===d)c+=';COUNT='+a.find('.countEvents').val();else if('until'===d){var e=a.find('.calendarUntil').val();e=app.getDateInDBInsertFormat(CONFIG.dateFormat,e),c+=';UNTIL='+e.replace(/-/gi,'')+'T235959';}if('WEEKLY'===b){var f=[];a.find('.repeatWeekUI [type="checkbox"]').each(function(){var a=$(this);a.is(':checked')&&f.push(a.val());}),0<f.length&&(c+=';BYDAY='+f.join(','));}if('MONTHLY'===b){var g=Vtiger_Helper_Js.getDay(a.find('[name="date_start"]').val()),h=Vtiger_Helper_Js.getDateInstance(a.find('[name="date_start"]').val(),CONFIG.dateFormat),i=h.getDate(),j=a.find('.calendarMontlyType:checked').val();if('DAY'==j){var k='';0===g?k='SU':1===g?k='MO':2===g?k='TU':3===g?k='WE':4===g?k='TU':5===g?k='FR':6===g?k='SA':void 0,c+=';BYDAY='+(parseInt((i-1)/7)+1)+k;}else c+=';BYMONTHDAY='+i;}return c},registerFormSubmitEvent:function d(){var a=this,b=this.getForm(),c=!0;app.getRecordId()&&b.on(Vtiger_Edit_Js.recordPreSave,function(a){c&&b.find('input[name="reapeat"]').is(':checked')&&(a.preventDefault(),app.showModalWindow(b.find('.typeSavingModal').clone(),function(a){a.find('.typeSavingBtn').on('click',function(a){var d=$(a.currentTarget);b.find('[name="typeSaving"]').val(d.data('value')),app.hideModalWindow(),c=!1,b.submit();});}));}),b.on('submit',function(d){var e=b.find('input[name="reapeat"]').is(':checked');if(e&&(app.getRecordId()&&c&&d.preventDefault(),b.find('[name="recurrence"]').val(a.getRule())),a.isEvents()){var f=b.find('.inviteesContent .inviteRow'),g=[];f.each(function(a,b){var c=jQuery(b);''!=c.data('crmid')&&g.push([c.data('email'),c.data('crmid'),c.data('ivid')]);}),jQuery('<input type="hidden" name="inviteesid" />').appendTo(b).val(JSON.stringify(g));}});},getFreeTime:function f(a){var b=a.find('[name="time_start"], [data-element-name="time_start"]'),c=a.find('[name="time_end"], [data-element-name="time_end"]'),d=a.find('[name="date_start"], [data-element-name="date_start"]'),e={module:'Calendar',action:'GetFreeTime',dateStart:d.val()};a.progressIndicator({}),AppConnector.request(e).done(function(e){a.progressIndicator({mode:'hide'}),b.val(e.result.time_start),c.val(e.result.time_end),d.val(e.result.date_start),a.find('[name="due_date"]').val(e.result.date_start);});},registerAutoFillHours:function e(a){var b=this,c=a.find('[name="allday"]'),d=a.find('[name="time_start"]'),f=a.find('[name="time_end"]'),g=a.find('[name="due_date"]');a.find('.autofill').on('change',function(h){var e=$(h.currentTarget);e.is(':checked')?(a.find('.autofill').prop('checked',!0),b.getFreeTime(a),d.attr('readonly','readonly'),f.attr('readonly','readonly'),c.attr('disabled','disabled'),c.prop('checked',!1),c.trigger('change'),g.attr('readonly','readonly')):(a.find('.autofill').prop('checked',!1),c.removeAttr('disabled'),d.removeAttr('readonly'),f.removeAttr('readonly'),g.removeAttr('readonly'));});},registerMarkAsCompletedBtn:function b(a){a.find('.js-btn--mark-as-completed').on('click',function(){var b=$(this);b.hasClass('active')?a.find('.js-completed').remove():a.append('<input class="js-completed" type=hidden name="markAsCompleted" value="PLL_COMPLETED" data-js="remove">');});},registerBasicEvents:function b(a){this._super(a),this.toggleTimesInputs(a),this.registerTimesInputs(a),this.registerTimeStartChangeEvent(a),this.registerActivityTypeChangeEvent(a),this.registerEndDateTimeChangeLogger(a),this.registerAutoFillHours(a),this.registerMarkAsCompletedBtn(a);},toggleTimesInputs:function b(a){a.find(':checkbox').on('change',function(){var b=$(this).attr('name');if('allday'==b){var c=$(this).is(':checked');a.find('#quickCreate').length||(c?a.find('.time').hide():a.find('.time').show());}});},registerTimesInputs:function c(a){var b=a.find('[name="allday"]:checkbox');b.prop('checked')&&a.find('.time').hide();},getDateInstance:function l(a,b){var c=a.find('[name="date_start"]'),d=a.find('[name="due_date"]'),e=a.find('[name="time_end"]'),f=a.find('[name="time_start"]'),g=c.val(),h=f.val(),i=e.val(),j=d.val(),k=CONFIG.dateFormat;return 'start'==b?Vtiger_Helper_Js.getDateInstance(g+' '+h,k):'end'==b?Vtiger_Helper_Js.getDateInstance(j+' '+i,k):void 0},registerInviteEvent:function d(a){this.registerRow(a);var b=a.find('.inviteesContent'),c=a.find('input.inviteesSearch');$.widget('custom.ivAutocomplete',$.ui.autocomplete,{_create:function a(){this._super(),this.widget().menu('option','items','> :not(.ui-autocomplete-category)');},_renderMenu:function e(a,b){var c=this,d='';$.each(b,function(b,e){e.category!=d&&(a.append('<li class=\'ui-autocomplete-category\'>'+e.category+'</li>'),d=e.category),c._renderItemData(a,e);});},_renderItemData:function c(a,b){return this._renderItem(a,b).data('ui-autocomplete-item',b)},_renderItem:function c(a,b){return $('<li>').data('item.autocomplete',b).append($('<a></a>').html(b.label)).appendTo(a)}}),c.ivAutocomplete({delay:'600',minLength:'3',source:function c(a,b){AppConnector.request({module:'Calendar',action:'Invitees',mode:'find',value:a.term}).done(function(a){var c=a.result;0>=c.length&&c.push({label:app.vtranslate('JS_NO_RESULTS_FOUND'),type:'no results',category:''}),b(c);});},select:function g(a,c){var d=c.item;if('undefined'!=typeof d.type&&'no results'==d.type)return !1;var e=!0;if(b.find('.inviteRow').each(function(){$(this).data('crmid')==d.id&&(e=!1);}),e){var f=b.find('.d-none .inviteRow').clone(!0,!0);Vtiger_Index_Js.getEmailFromRecord(d.id,d.module).done(function(a){f.data('crmid',d.id),f.data('email',a),f.find('.inviteName').data('content',d.fullLabel+a).text(d.label),f.find('.inviteIcon .c-badge__icon').removeClass('fas fa-envelope').addClass('userIcon-'+d.module),b.append(f);});}},close:function a(){c.val('');}});},registerRow:function b(a){a.on('click','.inviteRemove',function(a){$(a.target).closest('.inviteRow').remove();});},registerEvents:function c(){var a=this.proceedRegisterEvents();if(a){var b=this.getForm();this.registerReminderFieldCheckBox(),this.registerRecurrenceFieldCheckBox(),this.registerFormSubmitEvent(),this.registerRecurringTypeChangeEvent(),this.isEvents()&&this.registerInviteEvent(b),this._super();}}});
//# sourceMappingURL=Edit.min.js.map
