'use strict';

var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) {
  return typeof obj;
} : function (obj) {
  return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj;
};

$.Class('Vtiger_Inventory_Js',{},{inventoryContainer:!1,inventoryHeadContainer:!1,summaryTaxesContainer:!1,summaryDiscountContainer:!1,summaryCurrenciesContainer:!1,rowClass:'tr.inventoryRow',discountModalFields:['aggregationType','globalDiscount','groupCheckbox','groupDiscount','individualDiscount','individualDiscountType'],taxModalFields:['aggregationType','globalTax','groupCheckbox','groupTax','individualTax'],getInventoryItemsContainer:function a(){return !1===this.inventoryContainer&&(this.inventoryContainer=$('.inventoryItems')),this.inventoryContainer},getInventoryHeadContainer:function a(){return !1===this.inventoryHeadContainer&&(this.inventoryHeadContainer=$('.inventoryHeader')),this.inventoryHeadContainer},getInventorySummaryDiscountContainer:function a(){return !1===this.summaryDiscountContainer&&(this.summaryDiscountContainer=$('.inventorySummaryDiscounts')),this.summaryDiscountContainer},getInventorySummaryTaxesContainer:function a(){return !1===this.summaryTaxesContainer&&(this.summaryTaxesContainer=$('.inventorySummaryTaxes')),this.summaryTaxesContainer},getInventorySummaryCurrenciesContainer:function a(){return !1===this.summaryCurrenciesContainer&&(this.summaryCurrenciesContainer=$('.inventorySummaryCurrencies')),this.summaryCurrenciesContainer},getNextLineItemRowNumber:function c(){var a=$('#inventoryItemsNo'),b=parseInt(a.val());return a.val(b+1),++b},getAccountId:function b(){var a=$('#accountReferenceField').val();return ''==a?'':$('[name="'+a+'"]').val()},checkDeleteIcon:function b(){var a=this.getInventoryItemsContainer();1===a.data('isoptional')||(1<a.find(this.rowClass).length?this.showLineItemsDeleteIcon():this.hideLineItemsDeleteIcon());},showLineItemsDeleteIcon:function a(){this.getInventoryItemsContainer().find('.deleteRow').removeClass('d-none');},hideLineItemsDeleteIcon:function a(){this.getInventoryItemsContainer().find('.deleteRow').addClass('d-none');},getClosestRow:function b(a){return a.closest(this.rowClass)},getBasicRow:function a(){return $('#blackIthemTable').find('tbody').clone(!0,!0)},isRecordSelected:function d(a){var b=a.closest('tr'),c=b.find('.recordLabel');return c.validationEngine('validate')},getTaxModeSelectElement:function c(a){var b=this.getInventoryHeadContainer();return 0<b.find('thead .taxMode').length?$('.taxMode'):!!a&&a.find('.taxMode')},isIndividualTaxMode:function d(a){var b=this.getTaxModeSelectElement(a),c=b.find('option:selected');return '1'==c.val()},isGroupTaxMode:function c(){var a=this.getTaxModeSelectElement();if(a){var b=a.find('option:selected');if('0'==b.val())return !0}return !1},showIndividualTax:function h(a){var b=this,c=b.getInventorySummaryTaxesContainer().find('.groupTax'),d=b.getInventoryItemsContainer(),e=$('#blackIthemTable').find('tbody');if(b.isIndividualTaxMode()){c.addClass('d-none'),d.find('.changeTax').removeClass('d-none'),e.find('.changeTax').removeClass('d-none');var f=b.getInventoryItemsContainer(),g={aggregationType:'global'};f.find(b.rowClass).each(function(){var a=$(this);g.globalTax=app.parseNumberToShow(a.find('.js-tax').attr('data-default-tax')),b.setTaxParam(a,g);});}else b.setTax(d,0),b.setTaxParam(d,[]),b.setDefaultGlobalTax(a),c.removeClass('d-none'),d.find('.changeTax').addClass('d-none'),e.find('.changeTax').addClass('d-none');b.rowsCalculations();},setDefaultGlobalTax:function e(){var a=this,b=a.getInventoryItemsContainer(),c=a.getInventorySummaryTaxesContainer().find('.js-default-tax').data('tax-default-value'),d=a.isGroupTaxMode();if(!d)a.setTaxParam($('#blackIthemTable'),[]),b.closest('.inventoryItems').data('taxParam',[]);else if(c){var f={aggregationType:'global'};f.globalTax=app.parseNumberToShow(c),f.individualTax='',a.setTaxParam($('#blackIthemTable'),f),a.setTaxParam(b,f),b.closest('.inventoryItems').data('taxParam',JSON.stringify(f)),b.find(a.rowClass).each(function(){a.quantityChangeActions($(this));});}},getDiscountModeSelectElement:function c(a){var b=this.getInventoryHeadContainer();return 0<b.find('thead .discountMode').length?$('.discountMode'):a.find('.discountMode')},isIndividualDiscountMode:function d(a){var b=this.getDiscountModeSelectElement(a),c=b.find('option:selected');return '1'==c.val()},showIndividualDiscount:function e(){var a=this,b=a.getInventorySummaryDiscountContainer().find('.groupDiscount'),c=a.getInventoryItemsContainer(),d=$('#blackIthemTable').find('tbody');a.isIndividualDiscountMode()?(b.addClass('d-none'),c.find('.changeDiscount').removeClass('d-none'),d.find('.changeDiscount').removeClass('d-none')):(b.removeClass('d-none'),c.find('.changeDiscount').addClass('d-none'),c.find('.changeDiscount').addClass('d-none')),a.setDiscount(c,0),a.setDiscountParam(c,[]),a.rowsCalculations();},getCurrency:function b(){var a=$('[name="currency"]',this.getInventoryHeadContainer());return a.find('option:selected').val()},getTax:function b(a){return $('.tax',a).getNumberFromValue()},getTaxParams:function c(a){var b=a.find('.taxParam').val();return ''!=b&&'[]'!=b&&null!=b&&JSON.parse(b)},getQuantityValue:function b(a){return $('.qty',a).getNumberFromValue()},getUnitPriceValue:function b(a){return $('.unitPrice',a).getNumberFromValue()},getDiscount:function b(a){return $('.discount',a).getNumberFromValue()},getNetPrice:function b(a){return $('.netPrice',a).getNumberFromValue()},getTotalPrice:function b(a){return 0==$('.totalPrice',a).length?0:$('.totalPrice',a).getNumberFromValue()},getGrossPrice:function b(a){return $('.grossPrice',a).getNumberFromValue()},getPurchase:function e(a){var b=this.getQuantityValue(a),c=$('.purchase',a),d=0;return 0<c.length&&(d=app.parseNumberToFloat(c.val())),d*b},getSummaryGrossPrice:function c(){var a=this,b=0;return this.getInventoryItemsContainer().find(a.rowClass).each(function(){b+=a.getGrossPrice($(this));}),app.parseNumberToFloat(b)},setUnitPrice:function c(a,b){return b=app.parseNumberToShow(b),a.find('.unitPrice').val(b).attr('title',b),this},setNetPrice:function c(a,b){b=app.parseNumberToShow(b),$('.netPriceText',a).text(b),$('.netPrice',a).val(b);},setGrossPrice:function c(a,b){b=app.parseNumberToShow(b),$('.grossPriceText',a).text(b),$('.grossPrice',a).val(b);},setTotalPrice:function c(a,b){b=app.parseNumberToShow(b),$('.totalPriceText',a).text(b),$('.totalPrice',a).val(b);},setMargin:function c(a,b){b=app.parseNumberToShow(b),$('.margin',a).val(b);},setMarginP:function c(a,b){b=app.parseNumberToShow(b),$('.marginp',a).val(b);},setDiscount:function c(a,b){b=app.parseNumberToShow(b),$('.discount',a).val(b);},setDiscountParam:function c(a,b){$('.discountParam',a).val(JSON.stringify(b));},setTax:function c(a,b){b=app.parseNumberToShow(b),$('.tax',a).val(b);},setTaxParam:function c(a,b){$('.taxParam',a).val(JSON.stringify(b));},quantityChangeActions:function b(a){this.rowCalculations(a),this.summaryCalculations();},rowCalculations:function b(a){this.calculateTotalPrice(a),this.calculateDiscounts(a),this.calculateNetPrice(a),this.calculateTaxes(a),this.calculateGrossPrice(a),this.calculateMargin(a);},rowsCalculations:function b(){var a=this;this.getInventoryItemsContainer().find(a.rowClass).each(function(){a.quantityChangeActions($(this));}),a.calculateItemNumbers();},calculateDiscounts:function g(a){var b=a.find('.discountParam').val(),c=$('.aggregationTypeDiscount').val();if(''==b||'[]'==b||b==null)return 0;b=JSON.parse(b);var d=this.getTotalPrice(a),e=0,f=b.aggregationType;'string'==typeof f&&(f=[f]),f&&f.forEach(function(a){var f;if('individual'==a){f=b.individualDiscount;var g=b.individualDiscountType;e+='percentage'==g?d*(f/100):app.parseNumberToFloat(f);}'global'==a&&(e+=d*(app.parseNumberToFloat(b.globalDiscount)/100)),'group'==a&&(e+=d*(app.parseNumberToFloat(b.groupDiscount)/100)),'2'==c&&(d-=e);}),this.setDiscount(a,e);},calculateTaxes:function g(a){var b=a.find('.taxParam').val();if(''==b||'[]'==b||b==null)return 0;b=JSON.parse(b);var c=$('.aggregationTypeTax').val(),d=this.getNetPrice(a),e=0,f=b.aggregationType;'string'==typeof f&&(f=[f]),f&&f.forEach(function(a){var f=0;'individual'===a?f=b.individualTax:'global'===a?f=b.globalTax:'group'===a?f=b.groupTax:'regional'===a?f=b.regionalTax:void 0;e+=d*(app.parseNumberToFloat(f)/100),'2'==c&&(d+=e);}),this.setTax(a,e);},summaryCalculations:function b(){var a=this;a.getInventoryItemsContainer().find('tfoot .wisableTd').each(function(){a.calculatSummary($(this),$(this).data('sumfield'));}),a.calculatDiscountSummary(),a.calculatTaxSummary(),a.calculatCurrenciesSummary(),a.calculatMarginPSummary();},calculatSummary:function e(a,b){var c=this,d=0;this.getInventoryItemsContainer().find(c.rowClass).each(function(){var a=$(this).find('.'+b);0<a.length&&(d+=app.parseNumberToFloat(a.val()));}),a.text(app.parseNumberToShow(d));},calculatMarginPSummary:function f(){var a=this,b=a.getInventoryItemsContainer().find('tfoot'),c=app.parseNumberToFloat(b.find('[data-sumfield="purchase"]').text()),d=app.parseNumberToFloat(b.find('[data-sumfield="margin"]').text());d=app.parseNumberToFloat(d);var e='0';0!==c&&(e=100*(d/c)),b.find('[data-sumfield="marginP"]').text(app.parseNumberToShow(e));},calculatDiscountSummary:function d(){var a=this,b=a.getAllDiscount(),c=a.getInventorySummaryDiscountContainer();c.find('input').val(app.parseNumberToShow(b));},getAllDiscount:function c(){var a=this,b=0;return this.getInventoryItemsContainer().find(a.rowClass).each(function(){var c=$(this);b+=a.getDiscount(c);}),b},calculatCurrenciesSummary:function i(){var a=this,b=a.getInventorySummaryCurrenciesContainer(),c=$('[name="currency"] option:selected',a.getInventoryHeadContainer()),d=$('[name="currency"] option[data-base-currency="1"]',a.getInventoryHeadContainer()),e=c.data('conversionRate'),f=d.data('conversionRate');if(e==f)return void b.addClass('d-none');e=parseFloat(f)/parseFloat(e),b.removeClass('d-none');var g=a.getAllTaxs(),h=0;b.find('.js-panel__body').html(''),$.each(g,function(a,c){if(c!=null){c*=e;var d=b.find('.d-none .form-group').clone();d.find('.percent').text(a+'%'),d.find('input').val(app.parseNumberToShow(c)),d.appendTo(b.find('.js-panel__body')),h+=c;}}),b.find('.js-panel__footer input').val(app.parseNumberToShow(h));},calculatTaxSummary:function g(){var a=this,b=a.getAllTaxs(),c=a.getInventorySummaryTaxesContainer();c.find('.js-panel__body').html('');var d=0;for(var e in b){var f=c.find('.d-none .form-group').clone();f.find('.percent').text(app.parseNumberToShow(app.parseNumberToFloat(e))+'%'),f.find('input').val(app.parseNumberToShow(b[e])),f.appendTo(c.find('.js-panel__body')),d+=b[e];}c.find('.js-panel__footer input').val(app.parseNumberToShow(d));},getAllTaxs:function d(){var a=this,b=[],c=$('.aggregationTypeTax').val();return this.getInventoryItemsContainer().find(a.rowClass).each(function(){var d=$(this),e=a.getNetPrice(d),f=d.find('.taxParam').val();if(''!=f&&'[]'!=f&&null!=f){var g=JSON.parse(f);'string'==typeof g.aggregationType&&(g.aggregationType=[g.aggregationType]),g.aggregationType&&$.each(g.aggregationType,function(a,d){d+='Tax';var f=g[d],h=0;null!=b[f]&&(h=parseFloat(b[f]));var i=e*(app.parseNumberToFloat(f)/100);b[f]=h+i,'2'==c&&(e+=i);});}}),b},calculateNetPrice:function c(a){var b=this.getTotalPrice(a)-this.getDiscount(a);this.setNetPrice(a,b);},calculateGrossPrice:function c(a){var b=this.getNetPrice(a);(this.isIndividualTaxMode(a)||this.isGroupTaxMode(a))&&(b+=this.getTax(a)),this.setGrossPrice(a,b);},calculateTotalPrice:function c(a){var b=this.getQuantityValue(a)*this.getUnitPriceValue(a);this.setTotalPrice(a,b);},calculateMargin:function f(a){var b=$('.netPrice',a).length?this.getNetPrice(a):this.getTotalPrice(a);var c=this.getPurchase(a),d=b-c;this.setMargin(a,d);var e='0';0!==c&&(e=100*(d/c)),this.setMarginP(a,e);},calculateDiscount:function k(a,b){var c=app.parseNumberToFloat(b.find('.valueTotalPrice').text()),d=c,e=0,f=0,g=0,h=b.find('.discountsType').val();if('0'==h||'1'==h){if(0<b.find('.js-active .globalDiscount').length&&(e=app.parseNumberToFloat(b.find('.js-active .globalDiscount').val())),0<b.find('.js-active .individualDiscountType').length){var i=b.find('.js-active .individualDiscountType:checked').val(),j=app.parseNumberToFloat(b.find('.js-active .individualDiscountValue').val());g='percentage'==i?c*(j/100):j;}0<b.find('.js-active .groupCheckbox').length&&!0==b.find('.js-active .groupCheckbox').prop('checked')&&(f=app.parseNumberToFloat(b.find('.groupValue').val()),f=c*(f/100)),d*=(100-e)/100,d-=g,d-=f;}else'2'==h&&b.find('.js-active').each(function(){var a=$(this);if(0<a.find('.globalDiscount').length){var b=app.parseNumberToFloat(a.find('.globalDiscount').val());d*=(100-b)/100;}else if(0<a.find('.groupCheckbox').length&&!0==a.find('.groupCheckbox').prop('checked')){var c=app.parseNumberToFloat(a.find('.groupValue').val());d*=(100-c)/100;}else if(0<a.find('.individualDiscountType').length){var e=app.parseNumberToFloat(a.find('.individualDiscountValue').val());'percentage'==a.find('.individualDiscountType[name="individual"]:checked').val()?d*=(100-e)/100:d-=e;}});b.find('.valuePrices').text(app.parseNumberToShow(d)),b.find('.valueDiscount').text(app.parseNumberToShow(c-d));},calculateTax:function k(a,b){var c=app.parseNumberToFloat(b.find('.valueNetPrice').text()),d=c,e=0,f=0,g=0,h=0,i=b.find('.taxsType').val();if('0'==i||'1'==i){if(0<b.find('.js-active .globalTax').length&&(e=app.parseNumberToFloat(b.find('.js-active .globalTax').val())),0<b.find('.js-active .individualTaxValue').length){var j=app.parseNumberToFloat(b.find('.js-active .individualTaxValue').val());h=j/100*d;}0<b.find('.js-active .groupTax').length&&(f=app.parseNumberToFloat(b.find('.groupTax').val()),f=c*(f/100)),0<b.find('.js-active .regionalTax').length&&(g=app.parseNumberToFloat(b.find('.regionalTax').val()),g=c*(g/100)),d*=(100+e)/100,d+=h,d+=f,d+=g;}else'2'==i&&b.find('.js-active').each(function(){var a=$(this);if(0<a.find('.globalTax').length){var b=app.parseNumberToFloat(a.find('.globalTax').val());d*=(100+b)/100;}else if(0<a.find('.groupTax').length){var c=app.parseNumberToFloat(a.find('.groupTax').val());d*=(100+c)/100;}else if(0<a.find('.regionalTax').length){var e=app.parseNumberToFloat(a.find('.regionalTax').val());d*=(100+e)/100;}else if(0<a.find('.individualTaxValue').length){var f=app.parseNumberToFloat(a.find('.individualTaxValue').val());d=(f+100)/100*d;}});if(c){var l=100*((d-c)/c);b.find('.js-tax-value').text(app.parseNumberToShow(l));}b.find('.valuePrices').text(app.parseNumberToShow(d)),b.find('.valueTax').text(app.parseNumberToShow(d-c));},updateRowSequence:function b(){var a=this.getInventoryItemsContainer();a.find(this.rowClass).each(function(a){$(this).find('.sequence').val(a+1);});},registerInventorySaveData:function c(a){var b=this;a.on(Vtiger_Edit_Js.recordPreSave,function(){if(!b.checkLimits(a))return !1;var c=a.find('#blackIthemTable');c.find('[name]').removeAttr('name');});},pricebooksModalHandler:function e(a){var b=this,c=a.closest(this.rowClass),d=c.find('.rowName');app.showRecordsList({module:'PriceBooks',src_module:$('[name="popupReferenceModule"]',d).val(),src_record:$('.sourceField',d).val(),src_field:$('[name="popupReferenceModule"]',d).data('field'),currency_id:b.getCurrency()},function(a,e){e.setSelectEvent(function(a){AppConnector.request({module:'PriceBooks',action:'ProductListPrice',record:a.id,src_record:$('.sourceField',d).val()}).done(function(d){d.result?(b.setUnitPrice(c,d.result),b.quantityChangeActions(c)):app.errorLog('Incorrect data',a);});});});},subProductsCashe:[],loadSubProducts:function g(a,b){var c=this,d=$('input.sourceField',a).val(),e=a.find('.rowName input[name="popupReferenceModule"]').val();if(c.removeSubProducts(a),'0'==d||''==d||0>$.inArray(e,['Products','Services']))return !1;if(c.subProductsCashe[d])return c.addSubProducts(a,c.subProductsCashe[d]),!1;if(b)var f=$.progressIndicator();AppConnector.request({module:'Products',action:'SubProducts',record:d}).done(function(b){var e=b.result;c.subProductsCashe[d]=e,c.addSubProducts(a,e),f&&f.hide();}).fail(function(a,b){f&&f.hide(),console.error(a,b);});},removeSubProducts:function c(a){var b=$('.subProductsContainer ul',a);b.find('li').remove();},addSubProducts:function f(a,b){var c=$('.subProductsContainer ul',a);for(var d in b){var e=$('<li>').text(b[d]);c.append(e);}},mapResultsToFields:function r(a,b,c){var d=void 0,e=void 0,f=[],g=this,h=g.isGroupTaxMode();for(var i in c){var j=c[i],k=j.description,l=j.unitPriceValues,m=JSON.stringify(l);if(h){var n=b.closest('.inventoryItems').data('taxParam');n&&(f=JSON.parse(n));}else j.taxes&&(f={aggregationType:j.taxes.type},f[j.taxes.type+'Tax']=j.taxes.value);for(var o in j.taxes&&b.find('.js-tax').attr('data-default-tax',app.parseNumberToShow(j.taxes.value)),g.setTaxParam(b,f),g.setTax(b,0),j.autoFields)b.find('input.'+o).val(j.autoFields[o]),j.autoFields[o+'Text']&&b.find('.'+o+'Text').text(j.autoFields[o+'Text']);var s=g.getCurrency();s&&'undefined'!=typeof l[s]?e=l[s]:void 0!==j.price&&(e=j.price),e&&g.setUnitPrice(b,app.parseNumberToFloat(e)),void 0!==m&&$('input.unitPrice',b).attr('list-info',m);var p=$('textarea.commentTextarea',b.next()),q=CKEDITOR.instances[p.attr('id')];if(q?q.setData(k):p.val(k),'undefined'!=typeof j.autoFields.unit)switch(j.autoFields.unit){default:$('.qtyParamInfo',b).addClass('hidden'),d='validate[required,funcCall[Vtiger_NumberUserFormat_Validator_Js.invokeValidation]]',$('input.qty',b).attr('data-validation-engine',d);break;case'pack':$('.qtyParamInfo',b).removeClass('hidden').removeClass('active'),$('.qtyParamInfo',b).attr('data-content',j.qtyPerUnit),d='validate[required,funcCall[Vtiger_WholeNumber_Validator_Js.invokeValidation]]',$('input.qty',b).attr('data-validation-engine',d);break;case'pcs':$('.qtyParamInfo',b).addClass('hidden'),d='validate[required,funcCall[Vtiger_WholeNumber_Validator_Js.invokeValidation]]',$('input.qty',b).attr('data-validation-engine',d);}}'Products'===a&&g.loadSubProducts(b,!0),g.quantityChangeActions(b);},saveDiscountsParameters:function f(a,b){var c=this,d={},e=['aggregationType','groupCheckbox','individualDiscountType'];$.each(c.discountModalFields,function(a,c){if(0<=$.inArray(c,e))1<b.find('[name="'+c+'"]:checked').length?(d[c]=[],b.find('[name="'+c+'"]:checked').each(function(){d[c].push($(this).val());})):d[c]=b.find('[name="'+c+'"]:checked').val();else{var f=b.find('[name="'+c+'"]').val();'individualDiscount'===c&&(f=app.parseNumberToFloat(b.find('[name="'+c+'"]').val())),d[c]=f;}}),c.setDiscountParam($('#blackIthemTable'),d),c.setDiscountParam(a,d);},saveTaxsParameters:function f(a,b){var c=this,d={},e=['aggregationType','groupCheckbox','individualTaxType'];$.each(c.taxModalFields,function(a,c){0<=$.inArray(c,e)?1<b.find('[name="'+c+'"]:checked').length?(d[c]=[],b.find('[name="'+c+'"]:checked').each(function(){d[c].push($(this).val());})):d[c]=b.find('[name="'+c+'"]:checked').val():d[c]=b.find('[name="'+c+'"]').val();}),a.data('taxParam',JSON.stringify(d)),c.setTaxParam(a,d),c.setTaxParam($('#blackIthemTable'),d);},showExpandedRow:function g(a){var b=this,c=b.getInventoryItemsContainer(),d=c.find('[numrowex="'+a.attr('numrow')+'"]'),e=a.find('.toggleVisibility');e.data('status','1'),e.find('[data-fa-i2svg]').removeClass('fa-angle-down'),e.find('[data-fa-i2svg]').addClass('fa-angle-up'),d.removeClass('d-none');var f=Vtiger_Edit_Js.getInstance();$.each(d.find('.js-editor'),function(a,b){f.loadEditorElement($(b));});},hideExpandedRow:function f(a){var b=this,c=b.getInventoryItemsContainer(),d=c.find('[numrowex="'+a.attr('numrow')+'"]'),e=a.find('.toggleVisibility');e.data('status','0'),e.find('[data-fa-i2svg]').removeClass('fa-angle-up'),e.find('[data-fa-i2svg]').addClass('fa-angle-down'),d.addClass('d-none'),$.each(d.find('.js-editor'),function(a,b){var c=CKEDITOR.instances[$(b).attr('id')];c&&c.destroy();});},initDiscountsParameters:function e(a,b){var c=this,d=a.find('.discountParam').val();''==d||null==d||(d=JSON.parse(d),$.each(c.discountModalFields,function(a,c){var e=d[c],f=b.find('[name="'+c+'"]');if('checkbox'==f.attr('type')||'radio'==f.attr('type')){var g=e;$.isArray(g)||(g=[g]),$.each(g,function(a,b){var d=f.filter('[value="'+b+'"]').prop('checked',!0);'aggregationType'==c&&(d.closest('.js-panel').find('.js-panel__body').removeClass('d-none'),d.closest('.js-panel').addClass('js-active'));});}else'SELECT'==f.prop('tagName')?f.find('option[value="'+e+'"]').prop('selected','selected').change():b.find('[name="'+c+'"]').val(e);}),c.calculateDiscount(a,b));},initTaxParameters:function e(a,b){var c=this;if(a.data('taxParam'))var d=a.data('taxParam');else var d=a.find('.taxParam').val();d&&(d=JSON.parse(d),$.each(c.taxModalFields,function(a,c){var e=d[c],f=b.find('[name="'+c+'"]');if('checkbox'==f.attr('type')||'radio'==f.attr('type')){var g=e;$.isArray(g)||(g=[g]),$.each(g,function(a,b){var d=f.filter('[value="'+b+'"]').prop('checked',!0);'aggregationType'==c&&(d.closest('.js-panel').find('.js-panel__body').removeClass('d-none'),d.closest('.js-panel').addClass('js-active'));});}else'SELECT'==f.prop('tagName')?f.find('option[value="'+e+'"]').prop('selected','selected').change():b.find('[name="'+c+'"]').val(e);}),c.calculateTax(a,b));},limitEnableSave:!1,checkLimits:function g(){var a=this,b=a.getAccountId(),c=parseInt(app.getMainParams('inventoryLimit')),d=!0;if(''==b||a.limitEnableSave||!c)return d;var e={data:{module:app.getModuleName(),action:'Inventory',mode:'checkLimits',record:b,currency:a.getCurrency(),price:a.getSummaryGrossPrice()},async:!1,dataType:'json'},f=$.progressIndicator();return AppConnector.request(e).done(function(a){f.hide(),!1==a.result.status&&(app.showModalWindow(a.result.html,function(){}),d=!1);}).fail(function(a,b){f.hide(),console.error(a,b);}),d},currencyChangeActions:function d(a,b){var c=this;0==b.data('baseCurrency')?c.showCurrencyChangeModal(a,b):(c.currencyConvertValues(a,b),a.data('oldValue',a.val()));},showCurrencyChangeModal:function f(a,b){var c=this;if(!0!=c.lockCurrencyChange){c.lockCurrencyChange=!0;var d=a.closest('th'),e=d.find('.modelContainer').clone();app.showModalWindow(e,function(e){var f=$(e),g=JSON.parse(d.find('.currencyparam').val());if(!1!=g){if('undefined'==typeof g[b.val()]){var h=[];h.value=1,h.date='',g[b.val()]=h;}f.find('.currencyName').text(b.text()),f.find('.currencyRate').val(g[b.val()].value),f.find('.currencyDate').text(g[b.val()].date);}f.on('click','button[type="submit"]',function(){var e=f.find('.currencyRate').val(),h=app.parseNumberToFloat(e),i=1/app.parseNumberToFloat(e);b.data('conversionRate',i),g[b.val()]={value:h.toString(),conversion:i.toString()},d.find('.currencyparam').val(JSON.stringify(g)),c.currencyConvertValues(a,b),a.data('oldValue',a.val()),app.hideModalWindow(),c.lockCurrencyChange=!1;}),f.on('click','button[type="reset"]',function(){a.val(a.data('oldValue')).change(),c.lockCurrencyChange=!1;});});}},currencyConvertValues:function g(a,b){var c=this,d=a.find('option[value="'+a.data('oldValue')+'"]'),e=b.data('conversionRate'),f=d.data('conversionRate');e=parseFloat(e)/parseFloat(f),this.getInventoryItemsContainer().find(c.rowClass).each(function(){var a=$(this);c.setUnitPrice(a,app.parseNumberToFloat(c.getUnitPriceValue(a)*e)),c.setDiscount(a,app.parseNumberToFloat(c.getDiscount(a)*e)),c.setTax(a,app.parseNumberToFloat(c.getTax(a)*e)),c.quantityChangeActions(a);});},registerAddItem:function d(a){var b=this,c=this.getInventoryItemsContainer();a.find('.btn-toolbar .addItem').on('click',function(a){var d=b.getBasicRow(),e=b.getNextLineItemRowNumber(),f=$(a.currentTarget).data('module'),g=$(a.currentTarget).data('field'),h=d.html().replace(/_NUM_/g,e);d.html(h),d=d.find('tr').appendTo(c.find('tbody')),d.find('.rowName input[name="popupReferenceModule"]').val(f).data('field',g),d.find('.colPicklistField select').each(function(a,b){b=$(b),b.find('option').each(function(a,b){b=$(b),b.data('module')!=f&&b.remove();});}),b.initItem(d),Vtiger_Edit_Js.getInstance().registerAutoCompleteFields(d),app.showPopoverElementView(d.find('.js-popover-tooltip'));});},registerSortableItems:function c(){var a=this,b=a.getInventoryItemsContainer();b.sortable({handle:'.dragHandle',items:a.rowClass,revert:!0,tolerance:'pointer',placeholder:'ui-state-highlight',helper:function c(a,b){return b.children().each(function(a,b){b=$(b),b.width(b.width());}),b},start:function e(c,d){b.find(a.rowClass).each(function(b,c){var d=$(c);a.hideExpandedRow(d);}),d.item.startPos=d.item.index();},stop:function g(c,d){var e=$(d.item).attr('numrow'),f=b.find('.numRow'+e).remove().clone();b.find('[numrow="'+e+'"]').after(f),d.item.startPos<d.item.index()&&(f=b.find('.numRow'+e).next().remove().clone(),b.find('[numrow="'+e+'"]').before(f)),a.updateRowSequence();}});},registerShowHideExpanded:function c(a){var b=this;a.on('click','.toggleVisibility',function(a){var c=$(a.currentTarget),d=b.getClosestRow(c);'0'===c.data('status')?b.showExpandedRow(d):b.hideExpandedRow(d);});},registerPriceBookModal:function c(a){var b=this;a.on('click','.js-price-book-modal',function(a){var c=$(a.currentTarget),d=b.isRecordSelected(c);!0==d||b.pricebooksModalHandler(c);});},registerRowChangeEvent:function d(a){var b=this;a.on('focusout','.qty',function(a){var c=$(a.currentTarget);b.quantityChangeActions(b.getClosestRow(c));}),a.on('focusout','.unitPrice',function(a){var c=$(a.currentTarget);b.quantityChangeActions(b.getClosestRow(c));}),a.on('focusout','.purchase',function(a){var c=$(a.currentTarget);b.quantityChangeActions(b.getClosestRow(c));});var c=b.getInventoryHeadContainer();c.on('change','.taxMode',function(a){var c=$(a.currentTarget);b.showIndividualTax(b.getClosestRow(c)),b.rowsCalculations();}),c.on('change','.discountMode',function(a){var c=$(a.currentTarget);b.showIndividualDiscount(b.getClosestRow(c)),b.rowsCalculations();});},registerSubProducts:function c(a){var b=this;a.find('.inventoryItems '+b.rowClass).each(function(){b.loadSubProducts($(this),!1);});},registerClearReferenceSelection:function c(a){var b=this;a.on('click','.clearReferenceSelection',function(a){var c=$(a.currentTarget),d=b.getClosestRow(c);b.removeSubProducts(d),d.find('.unitPrice,.tax,.discount,.margin,.purchase').val(app.parseNumberToShow(0)),d.find('textarea,.valueVal').val(''),d.find('.valueText').text(''),d.find('.qtyParamInfo').addClass('hidden'),b.isGroupTaxMode()||b.setTaxParam(d,[]),b.quantityChangeActions(d);});},registerDeleteLineItemEvent:function c(a){var b=this;a.on('click','.deleteRow',function(c){var d=$(c.currentTarget),e=b.getClosestRow(d);a.find('[numrowex="'+e.attr('numrow')+'"]').remove(),e.remove(),b.checkDeleteIcon(),b.rowsCalculations(),0===b.getInventoryItemsContainer().find('.inventoryRow').length&&$('#inventoryItemsNo').val(0),b.updateRowSequence();});},registerChangeDiscount:function c(a){var b=this;a.on('click','.changeDiscount',function(a){var c,d=$(a.currentTarget),e={module:app.getModuleName(),view:'Inventory',mode:'showDiscounts',currency:b.getCurrency(),relatedRecord:b.getAccountId()};d.hasClass('groupDiscount')?(c=b.getInventoryItemsContainer(),e.totalPrice=0==c.find('tfoot .colTotalPrice').length?0:app.parseNumberToFloat(c.find('tfoot .colTotalPrice').text()),e.discountType=1):(c=d.closest(b.rowClass),e.totalPrice=b.getTotalPrice(c),e.discountType=0);var f=$.progressIndicator();AppConnector.request(e).done(function(a){app.showModalWindow(a,function(a){b.initDiscountsParameters(c,$(a)),b.registerChangeDiscountModal(a,c,e);}),f.hide();}).fail(function(a,b){f.hide(),console.error(a,b);});});},registerChangeDiscountModal:function e(a,b,c){var d=this;a.on('change','.individualDiscountType',function(b){var c=$(b.currentTarget);a.find('.individualDiscountContainer .input-group-text').text(c.data('symbol'));}),a.on('change','.activeCheckbox[name="aggregationType"]',function(b){var c=$(b.currentTarget);'checkbox'==c.attr('type')&&this.checked?(c.closest('.js-panel').find('.js-panel__body').removeClass('d-none'),c.closest('.js-panel').addClass('js-active')):'radio'==c.attr('type')?(a.find('.js-panel').removeClass('js-active'),a.find('.js-panel .js-panel__body').addClass('d-none'),c.closest('.js-panel').find('.js-panel__body').removeClass('d-none'),c.closest('.js-panel').addClass('js-active')):(c.closest('.js-panel').find('.js-panel__body').addClass('d-none'),c.closest('.js-panel').removeClass('js-active'));}),a.on('change','.activeCheckbox, .globalDiscount,.individualDiscountValue,.individualDiscountType,.groupCheckbox',function(){d.calculateDiscount(b,a);}),a.on('click','.saveDiscount',function(){if(d.saveDiscountsParameters(b,a),0==c.discountType)d.setDiscount(b,app.parseNumberToFloat(a.find('.valueDiscount').text())),d.quantityChangeActions(b);else{var e=app.parseNumberToFloat(a.find('.valueDiscount').text())/app.parseNumberToFloat(a.find('.valueTotalPrice').text());b.find(d.rowClass).each(function(){d.setDiscount($(this),d.getTotalPrice($(this))*e),d.quantityChangeActions($(this));});}app.hideModalWindow();});},registerChangeTax:function c(a){var b=this;a.on('click','.changeTax',function(a){var c,d=$(a.currentTarget),e={module:app.getModuleName(),view:'Inventory',mode:'showTaxes',currency:b.getCurrency(),sourceRecord:app.getRecordId()};if(d.hasClass('groupTax')){c=b.getInventoryItemsContainer();var f=0;0<c.find('tfoot .colNetPrice').length?f=c.find('tfoot .colNetPrice').text():0<c.find('tfoot .colTotalPrice ').length&&(f=c.find('tfoot .colTotalPrice ').text()),e.totalPrice=app.parseNumberToFloat(f),e.taxType=1;}else c=d.closest(b.rowClass),e.totalPrice=b.getNetPrice(c),e.taxType=0,e.record=c.find('.rowName .sourceField').val(),e.recordModule=c.find('.rowName [name="popupReferenceModule"]').val();var g=$.progressIndicator();AppConnector.request(e).done(function(a){app.showModalWindow(a,function(a){b.initTaxParameters(c,$(a)),b.registerChangeTaxModal(a,c,e);}),g.hide();}).fail(function(a,b){g.hide(),console.error(a,b);});});},lockCurrencyChange:!1,registerChangeCurrency:function c(a){var b=this;a.on('change','[name="currency"]',function(c){var d=$(c.currentTarget),e=d.find('option:selected').data('conversionSymbol');b.currencyChangeActions(d,d.find('option:selected')),a.find('.currencySymbol').text(e);});},registerChangeTaxModal:function e(a,b,c){var d=this;a.on('change','.individualTaxType',function(b){var c=$(b.currentTarget);a.find('.individualTaxContainer .input-group-text').text(c.data('symbol'));}),a.on('change','.activeCheckbox[name="aggregationType"]',function(b){var c=$(b.currentTarget);'checkbox'==c.attr('type')&&this.checked?(c.closest('.js-panel').find('.js-panel__body').removeClass('d-none'),c.closest('.js-panel').addClass('js-active')):'radio'==c.attr('type')?(a.find('.js-panel').removeClass('js-active'),a.find('.js-panel .js-panel__body').addClass('d-none'),c.closest('.js-panel').find('.js-panel__body').removeClass('d-none'),c.closest('.js-panel').addClass('js-active')):(c.closest('.js-panel').find('.js-panel__body').addClass('d-none'),c.closest('.js-panel').removeClass('js-active'));}),a.on('change','.activeCheckbox, .globalTax, .individualTaxValue, .groupTax, .regionalTax',function(){d.calculateTax(b,a);}),a.on('click','.saveTaxs',function(){if(d.saveTaxsParameters(b,a),'0'==c.taxType)d.setTax(b,app.parseNumberToFloat(a.find('.valueTax').text())),d.quantityChangeActions(b);else{var e=app.parseNumberToFloat(a.find('.valueTax').text())/app.parseNumberToFloat(a.find('.valueNetPrice').text());b.find(d.rowClass).each(function(){var a;0<$('.netPrice',$(this)).length?a=d.getNetPrice($(this)):0<$('.totalPrice',$(this)).length&&(a=d.getTotalPrice($(this))),d.setTax($(this),a*e),d.quantityChangeActions($(this));});}app.hideModalWindow();});},registerRowAutoComplete:function d(a){var b=this,c=a.find('.sourceField');c.on(Vtiger_Edit_Js.referenceSelectionEvent,function(a,c){var d=c.record,e=$(a.currentTarget),f=e.closest(b.rowClass),g=f.find('.rowName [name="popupReferenceModule"]').val(),h='index.php?module='+app.getModuleName()+'&action=Inventory&mode=getDetails&record='+d+'&fieldname='+e.data('columnname');b.getCurrency()&&(h+='&currency_id='+b.getCurrency()),AppConnector.request(h).done(function(a){for(var c in a)if('object'==_typeof(a[c])){var d=a[c];b.mapResultsToFields(g,f,d);}});});},calculateItemNumbers:function d(){var a=this,b=this.getInventoryItemsContainer(),c=1;b.find(a.rowClass).each(function(){$(this).find('.itemNumberText').text(c),c++;});},initItem:function c(a){var b=this;'undefined'==typeof a&&(a=b.getInventoryItemsContainer()),b.registerDeleteLineItemEvent(a),b.registerPriceBookModal(a),b.registerRowChangeEvent(a),b.registerRowAutoComplete(a),b.checkDeleteIcon(),b.rowsCalculations(),b.updateRowSequence(),App.Fields.Picklist.showSelect2ElementView(a.find('.selectInv')),App.Fields.Date.register(a,!0,{},'dateFieldInv'),a.validationEngine('detach'),a.validationEngine(app.validationEngineOptions);},registerEvents:function b(a){this.registerInventorySaveData(a),this.registerAddItem(a),this.initItem(),this.registerSortableItems(),this.registerSubProducts(a),this.registerChangeDiscount(a),this.registerChangeTax(a),this.registerClearReferenceSelection(a),this.registerShowHideExpanded(a),this.registerChangeCurrency(a),this.setDefaultGlobalTax(a);}}),$(document).ready(function(){var a=app.getModuleName(),b=a+'_Inventory_Js';if('undefined'==typeof window[b]&&(b='Vtiger_Inventory_Js'),'undefined'!=typeof window[b]){var c=new window[b];c.registerEvents(Vtiger_Edit_Js.getInstance().getForm());}});
//# sourceMappingURL=Inventory.min.js.map
