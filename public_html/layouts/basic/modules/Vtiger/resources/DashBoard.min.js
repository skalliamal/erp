'use strict';

var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) {
  return typeof obj;
} : function (obj) {
  return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj;
};

$.Class('Vtiger_DashBoard_Js',{grid:!1,currentInstance:!1,addWidget:function i(a,b){a=$(a);var c=a.data('linkid'),d=a.data('name'),e=a.data('id');$(a).parent().remove(),1>$('ul.widgetsList li').length&&$('ul.widgetsList').prev('button').css('visibility','hidden');var f=$('<div><div id="'+c+'-'+e+'" data-name="'+d+'" data-mode="open" class="grid-stack-item-content dashboardWidget new"></div></div>');f.find('.dashboardWidget').data('url',b);var g=a.data('width'),h=a.data('height');Vtiger_DashBoard_Js.grid.addWidget(f,0,0,g,h),Vtiger_DashBoard_Js.currentInstance.loadWidget(f.find('.grid-stack-item-content'));},restrictContentDrag:function b(a){a.on('mousedown.draggable',function(a){var b=$(a.target),c=!!(0<b.closest('.dashboardWidgetHeader').length);c||a.stopPropagation();});}},{container:!1,noCache:!1,instancesCache:{},init:function a(){Vtiger_DashBoard_Js.currentInstance=this;},getContainer:function a(){return (!0==this.noCache||!1==this.container)&&(this.container=$('.grid-stack')),this.container},getCurrentDashboard:function a(){return $('.selectDashboard li a.active').closest('li').data('id')},getWidgetInstance:function d(a){var b=a.attr('id');if(this.noCache||!(b in this.instancesCache)){var c=a.data('name');this.instancesCache[b]=Vtiger_Widget_Js.getInstance(a,c);}return this.instancesCache[b]},registerGrid:function b(){var a=this;if(Vtiger_DashBoard_Js.grid=this.getContainer().gridstack({verticalMargin:'0.5rem',alwaysShowResizeHandle:/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}).data('gridstack'),$('.grid-stack').on('change',function(){a.savePositions($('.grid-stack-item'));}),this.loadWidgets(),this.getContainer().width()!==this.getContainer().parent().width()){var c=a.getContainer().parent().width();this.getContainer().css('width',c+'px');}},savePositions:function g(a){for(var b,c={},d={},e=0,f=a.length;e<f;++e)b=$(a[e]),c[b.find('.grid-stack-item-content').attr('id')]=JSON.stringify({row:b.attr('data-gs-y'),col:b.attr('data-gs-x')}),d[b.find('.grid-stack-item-content').attr('id')]=JSON.stringify({width:b.attr('data-gs-width'),height:b.attr('data-gs-height')});this.updateLazyWidget(),AppConnector.request({module:app.getModuleName(),action:'SaveWidgetPositions',position:c,size:d});},updateLazyWidget:function b(){var a=$('.mainBody').scrollTop();$('.mainBody').scrollTop(a+1).scrollTop(a);},loadWidgets:function b(){var a=this;a.getContainer().find('.dashboardWidget').Lazy({threshold:0,appendScroll:$('.mainBody'),widgetLoader:function c(b){a.loadWidget(b);}}),this.updateLazyWidget();},loadWidget:function i(a){var b=this,c=a.data('url'),d=a.data('mode');if(a.progressIndicator(),'open'===d){var e=a.data('name'),f=a.data('cache'),g=CONFIG.userId;if(1===f){var h=app.cacheGet(e+g,!1);c=h?h:c;}AppConnector.request(c).done(function(c){a.html(c),App.Fields.Picklist.showSelect2ElementView(a.find('.select2')),b.getWidgetInstance(a),a.trigger(Vtiger_Widget_Js.widgetPostLoadEvent);var d=a.find('.dashboardWidgetHeader').outerHeight(),e=a.height()-d;a.find('.dashboardWidgetFooter').length&&(e-=a.find('.dashboardWidgetFooter').outerHeight());var f=a.find('.dashboardWidgetContent');f.css('max-height',e+'px'),app.showNewScrollbar(f,{wheelPropagation:!0});});}},registerRefreshWidget:function b(){var a=this;this.getContainer().on('click','a[name="drefresh"]',function(b){var c=$(b.currentTarget),d=c.closest('.dashboardWidget'),e=a.getWidgetInstance(d);e.refreshWidget();});},removeWidget:function b(){var a=this;this.getContainer().on('click','.grid-stack-item a[name="dclose"]',function(b){var c=$(b.currentTarget),d=$(c).parents('.grid-stack-item'),e=d.attr('data-sizex'),f=d.attr('data-sizey'),g=c.data('url'),h=c.closest('.dashboardWidgetHeader').parent(),i=h.data('name'),j=h.find('.dashboardTitle').attr('title'),k=app.vtranslate('JS_ARE_YOU_SURE_TO_DELETE_WIDGET')+' ['+j+']. '+app.vtranslate('JS_ARE_YOU_SURE_TO_DELETE_WIDGET_INFO');Vtiger_Helper_Js.showConfirmationBox({message:k}).done(function(){AppConnector.request(g).done(function(b){if(b.success){if(h.fadeOut('slow',function(){h.remove();}),-1==$.inArray(i,[])){Vtiger_DashBoard_Js.grid.removeWidget(c.closest('.grid-stack-item')),$('.widgetsList').prev('button').css('visibility','visible');var d='<li class="d-flex flex-row-reverse align-items-center">';b.result.deleteFromList&&(d+='<button ',d+='data-widget-id="'+b.result.id+'" ',d+='class="removeWidgetFromList btn btn-danger btn-sm m-1 p-1" ',d+='>',d+='<span class="fas fa-trash-alt"></span>',d+='</button>'),d+='<a onclick="Vtiger_DashBoard_Js.addWidget(this, \''+b.result.url+'\')" ',d+='href="javascript:void(0);" ',d+='class="dropdown-item pl-1" ',d+='data-linkid="'+b.result.linkid+'" ',d+='data-name="'+b.result.name+'" ',d+='data-width="'+e+'" ',d+='data-height="'+f+'" ',d+='>',d+=b.result.title+'</a>',d+='</li>';var g=$('.widgetsList .dropdown-divider');g.length?$(d).insertBefore(g):$('.widgetsList').append(d),a.updateLazyWidget();}}});}).fail(function(){});});},registerSelectDashboard:function b(){var a=this;$('.selectDashboard li').on('click',function(b){var c=$.progressIndicator({position:'html',blockInfo:{enabled:!0}}),d=$(b.currentTarget),e=d.data('id'),f={module:app.getModuleName(),view:app.getViewName(),dashboardId:e};AppConnector.request(f).done(function(b){c.progressIndicator({mode:'hide'}),$('.dashboardViewContainer').html(b),a.noCache=!0,a.registerEvents();});});},registerDatePickerHideInitiater:function b(){var a=this.getContainer();a.on('click','input.dateRange',function(a){var b=$(a.currentTarget).closest('.dashboardWidget'),c=$('.dashboardWidgetHeader',b);return Vtiger_Helper_Js.addClickOutSideEvent(c.find('.dateRange'),function b(){var a=$('.dateRange');a.DatePickerHide(),a.blur();}),!1});},registerShowMailBody:function b(){var a=this.getContainer();a.on('click','.showMailBody',function(a){var b=$(a.currentTarget).closest('.mailRow'),c=b.find('.mailBody'),d=$(a.currentTarget).find('.body-icon');'none'==c.css('display')?(c.show(),d.removeClass('fa-chevron-down').addClass('fa-chevron-up')):(c.hide(),d.removeClass('fa-chevron-up').addClass('fa-chevron-down'));});},registerChangeMailUser:function c(){var b=this.getContainer();b.on('change','#mailUserList',function(a){var b=$(a.currentTarget),c=b.closest('.dashboardWidget'),d=c.find('.dashboardWidgetContent'),e=$('option:selected',this),f=c.data('url')+'&user='+e.val(),g={};g.url=f,g.data={},d.progressIndicator({}),AppConnector.request(g).done(function(a){d.progressIndicator({mode:'hide'}),c.html(a).trigger(Vtiger_Widget_Js.widgetPostRefereshEvent);}).fail(function(){d.progressIndicator({mode:'hide'});});});},registerChartFilterWidget:function b(){var a=this;$('.dashboardHeading').off('click','.addChartFilter').on('click','.addChartFilter',function(b){var c=$(b.currentTarget);app.showModalWindow(null,'index.php?module=Home&view=ChartFilter&step=step1',function(b){var d=$('form',b);d.on('keypress',function(a){return 13!=a.keyCode});var e=d.find('.sectorContainer'),f=$('select[name="chartType"]',b),g=$('select[name="module"]',b);App.Fields.Picklist.showSelect2ElementView(e.find('.select2'));var h=App.Fields.Picklist.showSelect2ElementView(g,{placeholder:app.vtranslate('JS_SELECT_MODULE')}),i=$('.step1',b),j=$('.step2',b),k=$('.step3',b),l=$('.modal-footer',b);j.remove(),k.remove(),l.hide(),f.on('change',function(a){var c=$(a.currentTarget),e=c.val();'Barchat'==e||'Horizontal'==e?d.find('.isColorContainer').removeClass('d-none'):d.find('.isColorContainer').addClass('d-none'),4==b.find('#widgetStep').val()&&b.find('.step3 .groupField').trigger('change');}),h.on('change',function(){h.val()&&(l.hide(),b.find('.step2').remove(),b.find('.step3').remove(),AppConnector.request({module:'Home',view:'ChartFilter',step:'step2',chartType:f.val(),selectedModule:h.val()}).done(function(a){i.after(a),b.find('#widgetStep').val(2);var c=b.find('.step2');l.hide();var d=c.find('.filtersId'),e=c.find('.valueType');App.Fields.Picklist.showSelect2ElementView(d),App.Fields.Picklist.showSelect2ElementView(e),c.find('.filtersId, .valueType').on('change',function(){b.find('.step3').remove(),b.find('.step4').remove(),AppConnector.request({module:'Home',view:'ChartFilter',step:'step3',selectedModule:h.val(),chartType:f.val(),filtersId:d.val(),valueType:e.val()}).done(function(a){c.last().after(a),b.find('#widgetStep').val(3);var e=b.find('.step3');App.Fields.Picklist.showSelect2ElementView(e.find('select')),l.hide(),e.find('.groupField').on('change',function(){b.find('.step4').remove();var a=$(this);a.val()&&(l.show(),AppConnector.request({module:'Home',view:'ChartFilter',step:'step4',selectedModule:h.val(),filtersId:d.val(),groupField:a.val(),chartType:f.val()}).done(function(a){e.last().after(a),b.find('#widgetStep').val(4);var c=b.find('.step4');App.Fields.Picklist.showSelect2ElementView(c.find('select')),app.registerModalEvents(b);}));});});});}));}),d.on('submit',function(b){b.preventDefault();var e=!0;if(b.preventDefault(),0<d.data('jqv').InvalidFields.length&&(app.formAlignmentAfterValidation(d),e=!1),e){var g=h.val(),i=h.find(':selected').text(),j=d.find('.filtersId').val();Array.isArray(j)&&(j=j.join(','));var k=d.find('.filterId').find(':selected').text(),l=d.find('.groupField').find(':selected').text(),m={module:g,groupField:d.find('.groupField').val(),chartType:f.val()};d.find('.saveParam').each(function(a,b){b=$(b),b.is('input')&&'checkbox'===b.prop('type')&&!b.prop('checked')||(m[b.attr('name')]=b.val());}),a.saveChartFilterWidget(m,c,i,j,'',l,d);}});});});},saveChartFilterWidget:function l(a,b,c,d,e,f,g){var h=this,i=c;'undefined'!=typeof e&&null!==e&&''!==e&&(i+=' - '+e),'undefined'!=typeof f&&null!==f&&''!==f&&(i+=' - '+f);var j={data:JSON.stringify(a),blockid:b.data('block-id'),linkid:b.data('linkid'),label:i,name:'ChartFilter',title:g.find('[name="widgetTitle"]').val(),filterid:d,isdefault:0,height:4,width:4,owners_all:['mine','all','users','groups'],default_owner:'mine',dashboardId:h.getCurrentDashboard()},k=$('[name="selectedModuleName"]').val();h.saveWidget(j,'add',k,j.linkid).done(function(a){var c=a.result,d={};if(a.success){app.hideModalWindow(),j.id=c.id,j.status=c.status,d.text=c.text,d.type='success';var e=b.clone();e.data('name','ChartFilter'),e.data('id',c.wid),Vtiger_DashBoard_Js.addWidget(e,'index.php?module=Home&view=ShowWidget&name=ChartFilter&linkid='+b.data('linkid')+'&widgetid='+c.wid+'&active=0'),Vtiger_Helper_Js.showMessage(d);}else{var f=a.error.message;if(513!=a.error.code)var h=g.find('[name="fieldName"]');else var h=g.find('[name="fieldLabel"]');h.validationEngine('showPrompt',f,'error','topLeft',!0);}});},registerMiniListWidget:function b(){var a=this;$('.dashboardHeading').off('click','.addFilter').on('click','.addFilter',function(b){var c=$(b.currentTarget);app.showModalWindow(null,'index.php?module=Home&view=MiniListWizard&step=step1',function(b){var d=$('form',b);d.on('keypress',function(a){return 13!=a.keyCode});var e=$('select[name="module"]',b),f=$('select[name="filterid"]',b),g=$('select[name="fields"]',b),h=$('select[name="filter_fields"]',b),i=App.Fields.Picklist.showSelect2ElementView(e,{placeholder:app.vtranslate('JS_SELECT_MODULE')}),j=App.Fields.Picklist.showSelect2ElementView(f,{placeholder:app.vtranslate('JS_PLEASE_SELECT_ATLEAST_ONE_OPTION'),dropdownParent:b}),k=App.Fields.Picklist.showSelect2ElementView(g,{placeholder:app.vtranslate('JS_PLEASE_SELECT_ATLEAST_ONE_OPTION'),closeOnSelect:!0,maximumSelectionLength:6}),l=App.Fields.Picklist.showSelect2ElementView(h,{placeholder:app.vtranslate('JS_PLEASE_SELECT_ATLEAST_ONE_OPTION')}),m=$('.modal-footer',b);f.closest('tr').hide(),g.closest('tr').hide(),m.hide(),i.on('change',function(){i.val()&&(m.hide(),g.closest('tr').hide(),AppConnector.request({module:'Home',view:'MiniListWizard',step:'step2',selectedModule:i.val()}).done(function(a){f.empty().html(a).trigger('change'),j.closest('tr').show();}));}),j.on('change',function(){j.val()&&AppConnector.request({module:'Home',view:'MiniListWizard',step:'step3',selectedModule:i.val(),filterid:j.val()}).done(function(a){var b=$(a),c=b.find('select[name="fields"]').html(),d=b.find('select[name="filter_fields"]').html();g.empty().html(c).trigger('change'),k.closest('tr').show(),k.data('select2').$selection.find('.select2-search__field').parent().css('width','100%'),h.empty().html(d).trigger('change'),l.closest('tr').show(),l.data('select2').$selection.find('.select2-search__field').parent().css('width','100%');});}),k.on('change',function(){k.val()?m.show():m.hide();}),d.on('submit',function(b){b.preventDefault();var e=i.val(),f=i.find(':selected').text(),g=j.val(),h=j.find(':selected').text(),l=[];k.select2('data').map(function(a){l.push(a.id);});var m={module:e};'object'!=('undefined'==typeof l?'undefined':_typeof(l))&&(l=[l]),m.fields=l,a.saveMiniListWidget(m,c,f,g,h,d);});});});},saveMiniListWidget:function j(a,b,c,d,e,f){var g=this,h={data:JSON.stringify(a),blockid:b.data('block-id'),linkid:b.data('linkid'),label:c+' - '+e,title:f.find('[name="widgetTitle"]').val(),name:'Mini List',filterid:d,isdefault:0,height:4,width:4,owners_all:['mine','all','users','groups'],default_owner:'mine',dashboardId:g.getCurrentDashboard()},i=$('[name="selectedModuleName"]').val();g.saveWidget(h,'add',i,h.linkid).done(function(a){var c=a.result,d={};if(a.success){app.hideModalWindow(),h.id=c.id,h.status=c.status,d.text=c.text,d.type='success';var e=b.clone();e.data('name','MiniList'),e.data('id',c.wid),Vtiger_DashBoard_Js.addWidget(e,'index.php?module=Home&view=ShowWidget&name=MiniList&linkid='+b.data('linkid')+'&widgetid='+c.wid+'&active=0'),Vtiger_Helper_Js.showMessage(d);}else{var g=a.error.message;if(513!=a.error.code)var i=f.find('[name="fieldName"]');else var i=f.find('[name="fieldLabel"]');i.validationEngine('showPrompt',g,'error','topLeft',!0);}});},saveWidget:function h(a,b,c,d){var e=$.Deferred(),f=$.progressIndicator({position:'html',blockInfo:{enabled:!0}});'undefined'==typeof c&&(c=app.getModuleName());var g={form:a,module:app.getModuleName(),sourceModule:c,action:'Widget',mode:b,addToUser:!0,linkid:d};return AppConnector.request(g).done(function(a){f.progressIndicator({mode:'hide'}),e.resolve(a);}).fail(function(a){f.progressIndicator({mode:'hide'}),e.reject(a);}),e.promise()},registerTabModules:function b(){var a=this;$('.selectDashboradView li').on('click',function(b){var c=$(b.currentTarget);$('.selectDashboradView li').removeClass('active'),c.addClass('active');var d={module:c.data('module'),view:app.getViewName(),sourceModule:app.getModuleName(),dashboardId:a.getCurrentDashboard()};AppConnector.request(d).done(function(b){$('.dashboardViewContainer').html(b),a.noCache=!0,a.registerEvents();});});},removeWidgetFromList:function b(){var a=this;$('.dashboardHeading').on('click','.removeWidgetFromList',function(b){var c=$(b.currentTarget),d=c.data('widget-id'),e={module:app.getModuleName(),action:'Widget',mode:'removeWidgetFromList',widgetid:d};AppConnector.request(e).done(function(){var b={text:app.vtranslate('JS_WIDGET_DELETED'),type:'success'};Vtiger_Helper_Js.showMessage(b);var d=c.closest('.dashboardWidget');$(d).remove(),a.updateLazyWidget();});});},registerEvents:function a(){this.registerGrid(),this.registerRefreshWidget(),this.removeWidget(),this.registerDatePickerHideInitiater(),this.registerShowMailBody(),this.registerChangeMailUser(),this.registerMiniListWidget(),this.registerChartFilterWidget(),this.registerTabModules(),this.removeWidgetFromList(),this.registerSelectDashboard();}});
//# sourceMappingURL=DashBoard.min.js.map
