'use strict';

jQuery.Class("Vtiger_Detail_Js",{detailInstance:!1,getInstance:function i(){if(!1==Vtiger_Detail_Js.detailInstance){var e=app.getModuleName(),t=app.getViewName(),a=e+"_"+t+"_Js",d=Vtiger_Detail_Js;if("undefined"!=typeof window[a])var n=new window[a];else var n=new d;Vtiger_Detail_Js.detailInstance=n;}return Vtiger_Detail_Js.detailInstance},triggerDetailViewAction:function i(e,t){var a=Vtiger_Detail_Js.getInstance(),d=[];d.push(a.getRecordId());var n={selected_ids:JSON.stringify(d)};AppConnector.request({type:"POST",url:e,dataType:"html",data:n}).done(function(e){e&&(app.showModalWindow(e,{"text-align":"left"}),"function"==typeof t&&t(e));}).fail(function(){});},triggerSendSms:function t(e){Vtiger_Detail_Js.triggerDetailViewAction(e);},triggerTransferOwnership:function a(e){var t=this;t.getRelatedModulesContainer=!1;AppConnector.request({type:"POST",url:e,dataType:"html",data:{}}).done(function(e){if(e){var a=function(){var e=app.validationEngineOptions;e.onValidationComplete=function(e,a){return a&&"changeOwner"==e.attr("name")&&t.transferOwnershipSave(e),!1},jQuery("#changeOwner").validationEngine(app.validationEngineOptions);};app.showModalWindow(e,function(e){var d=t.getRelatedModuleContainer();App.Fields.Picklist.changeSelectElementView(d,"select2"),"function"==typeof a&&a(e);});}});},transferOwnershipSave:function i(){var t=jQuery("#transferOwnerId").val(),a=jQuery("#related_modules").val(),d=jQuery("#recordId").val(),n={module:app.getModuleName(),action:"TransferOwnership",record:d,transferOwnerId:t,related_modules:a};AppConnector.request(n).done(function(e){if(e.success){app.hideModalWindow();var a={title:app.vtranslate("JS_MESSAGE"),text:app.vtranslate("JS_RECORDS_TRANSFERRED_SUCCESSFULLY"),type:"info"},d=jQuery(".assigned_user_id").val(),n=jQuery(".assigned_user_id ");n.find("option[value=\""+d+"\"]").removeAttr("selected"),n.find("option[value=\""+t+"\"]").attr("selected","selected"),n.trigger("liszt:updated");var i=n.find("option[value=\""+t+"\"]").data("picklistvalue");n.closest(".row-fluid").find(".value").html("<a href=\"index.php?module=Users&amp;parent=Settings&amp;view=Detail&amp;record="+t+"\">"+i+"</a>"),Vtiger_Helper_Js.showPnotify(a);}});},getRelatedModuleContainer:function e(){return !1==this.getRelatedModulesContainer&&(this.getRelatedModulesContainer=jQuery("#related_modules")),this.getRelatedModulesContainer},reloadRelatedList:function a(){var e=Vtiger_Detail_Js.getInstance(),t={};0<jQuery("[name=\"currentPageNum\"]").length&&(t.page=jQuery("[name=\"currentPageNum\"]").val()),e.loadRelatedList(t);},showWorkflowTriggerView:function n(e){$(e).popover("hide");var t=Vtiger_Detail_Js.getInstance(),a={module:app.getModuleName(),view:"WorkflowTrigger",record:t.getRecordId()},d=function(e){e.find("[type=\"submit\"]").on("click",function(){var a=[];if(e.find("input[type=\"checkbox\"]:checked").each(function(){a.push($(this).val());}),0==a.length){var d={title:app.vtranslate("JS_INFORMATION"),text:app.vtranslate("JS_NOT_SELECTED_WORKFLOW_TRIGGER"),type:"error"};Vtiger_Helper_Js.showPnotify(d);}else{var d={title:app.vtranslate("JS_MESSAGE"),text:app.vtranslate("JS_STARTED_PERFORM_WORKFLOW"),type:"info"};Vtiger_Helper_Js.showPnotify(d);var n={module:app.getModuleName(),action:"Workflow",mode:"execute",user:e.find("[name=\"user\"]").val(),record:t.getRecordId(),ids:a};AppConnector.request(n).done(function(){var e={title:app.vtranslate("JS_MESSAGE"),text:app.vtranslate("JS_COMPLETED_PERFORM_WORKFLOW"),type:"success"};Vtiger_Helper_Js.showPnotify(e),app.hideModalWindow(),t.loadWidgets();}).fail(function(){var e={title:app.vtranslate("JS_ERROR"),text:app.vtranslate("JS_ERROR_DURING_TRIGGER_OF_WORKFLOW"),type:"error"};Vtiger_Helper_Js.showPnotify(e),app.hideModalWindow();});}});};AppConnector.request(a).done(function(e){e&&app.showModalWindow(e,"",d);}).fail(function(){});}},{targetPicklistChange:!1,targetPicklist:!1,detailViewContentHolder:!1,detailViewForm:!1,detailViewDetailsTabLabel:"LBL_RECORD_DETAILS",detailViewSummaryTabLabel:"LBL_RECORD_SUMMARY",detailViewRecentCommentsTabLabel:"ModComments",detailViewRecentActivitiesTabLabel:"Activities",detailViewRecentUpdatesTabLabel:"LBL_UPDATES",detailViewRecentDocumentsTabLabel:"Documents",fieldUpdatedEvent:"Vtiger.Field.Updated",updatedFields:["company","designation","title"],fieldPreSave:"Vtiger.Field.PreSave",tempData:[],referenceFieldNames:{Calendar:{Accounts:"link",Leads:"link",Vendors:"link",OSSEmployees:"link",Contacts:"linkextend",Campaigns:"process",HelpDesk:"process",Projects:"process",ServiceContracts:"process"},OutsourcedProducts:{Leads:"parent_id",Accounts:"parent_id",Contacts:"parent_id"},Assets:{Accounts:"parent_id",Contacts:"parent_id"},OSSOutsourcedServices:{Leads:"parent_id",Accounts:"parent_id",Contacts:"parent_id"},OSSSoldServices:{Accounts:"parent_id",Contacts:"parent_id"}},init:function e(){},loadWidgetsEvents:function e(){var t=this;app.event.on("DetailView.Widget.AfterLoad",function(a,e,d){"Calendar"===d&&t.reloadWidgetActivitesStats(e.closest(".activityWidgetContainer")),"ModComments"===d&&t.registerCommentEventsInDetail(e.closest(".updatesWidgetContainer")),e.find("[name=\"relatedModule\"]").length&&t.registerShowSummary(e),"Emails"===d&&(Vtiger_Index_Js.registerMailButtons(e),e.find(".showMailModal").on("click",function(t){var e=jQuery.progressIndicator();app.showModalWindow("",$(t.currentTarget).data("url")+"&noloadlibs=1",function(t){Vtiger_Index_Js.registerMailButtons(t),e.progressIndicator({mode:"hide"});});})),t.registerEmailEvents(e),"DetailView"===d&&t.registerBlockStatusCheckOnLoad();});},loadWidgets:function a(){var e=this,t=jQuery("[class^=\"widgetContainer_\"]");t.each(function(t,a){var d=jQuery(a);e.loadWidget(d);}),e.registerRelatedModulesRecordCount();},loadWidget:function g(e,t){var a=this,d=jQuery(".js-detail-widget-content",e);if(e.find("[name=\"relatedModule\"]").length)var n=e.find("[name=\"relatedModule\"]").val();else var n=e.data("name");if(null==t){var i=e.data("url");if(null==i)return;for(var o=i.split("&"),r={},l=0;l<o.length;l++){var s=o[l],c=s.split("=");r[c[0]]=c[1];}t=r;}var m=$.Deferred();return d.progressIndicator({}),AppConnector.request({type:"POST",async:!1,dataType:"html",data:t}).done(function(i){if(d.progressIndicator({mode:"hide"}),d.html(i),App.Fields.Picklist.showSelect2ElementView(e.find(".select2")),app.showPopoverElementView(d.find(".js-popover-tooltip")),app.registerModal(d),app.registerMoreContent(d.find("button.moreBtn")),n){var o=Vtiger_RelatedList_Js.getInstance(a.getRecordId(),app.getModuleName(),a.getSelectedTab(),n);o.setRelatedContainer(d),o.registerRelatedEvents(),a.widgetRelatedRecordView(e,!0);}app.event.trigger("DetailView.Widget.AfterLoad",d,n,a),m.resolve(t);}).fail(function(){d.progressIndicator({mode:"hide"}),m.reject();}),m.promise()},widgetRelatedRecordView:function s(e,t){var a=this.getRecordId()+"_"+e.data("id"),d=app.moduleCacheGet(a);if(null!==d){var n=e.find(".js-carousel-item[data-id = '"+d+"']");n.length&&(e.find(".js-carousel-item.active").removeClass("active"),e.find(".js-carousel-item[data-id = '"+d+"']").addClass("active"));}var i=e.find(".control-widget"),o=i.find(".prev"),r=i.find(".next"),l=e.find(".js-carousel-item.active");1>=e.find(".js-carousel-item").length||!l.next().length?r.addClass("disabled"):r.removeClass("disabled"),1>=e.find(".js-carousel-item").length||!l.prev().length?o.addClass("disabled"):o.removeClass("disabled"),t&&(r.on("click",function(){if(!$(this).hasClass("disabled")){var t=e.find(".js-carousel-item.active");t.removeClass("active");var d=t.next();d.addClass("active"),d.next().length||r.addClass("disabled"),t.prev()&&o.removeClass("disabled"),app.moduleCacheSet(a,d.data("id"));}}),o.on("click",function(){if(!$(this).hasClass("disabled")){var t=e.find(".js-carousel-item.active");t.removeClass("active");var d=t.prev();d.addClass("active"),d.prev().length||o.addClass("disabled"),t.next()&&r.removeClass("disabled"),app.moduleCacheSet(a,d.data("id"));}}));},loadCommentsWidget:function e(){},loadContents:function o(e,t){var a=this,d=jQuery.Deferred(),n=this.getContentHolder(),i=e;return "undefined"!=typeof t&&(i={},i.url=e,i.data=t),AppConnector.requestPjax(i).done(function(e){n.html(e),e=n.html(),a.registerBlockStatusCheckOnLoad(),App.Fields.Picklist.changeSelectElementView(n),App.Fields.Date.register(n),a.getForm().validationEngine(),app.event.trigger("DetailView.LoadContents.AfterLoad",e),d.resolve(e);}),d.promise()},getUpdatefFieldsArray:function e(){return this.updatedFields},getTabByLabel:function d(e){var t=this.getTabs(),a=!1;return t.each(function(t,d){var n=jQuery(d),i=n.data("labelKey");if(i==e)return a=n,!1}),a},getTabByModule:function d(e){var t=this.getTabs(),a=!1;return t.each(function(t,d){var n=jQuery(d);if(n.data("reference")==e)return a=n,!1}),a},selectModuleTab:function a(){var e=this.getTabContainer(),t=e.find("li.module-tab");this.deSelectAllrelatedTabs(),this.markTabAsSelected(t);},deSelectAllrelatedTabs:function e(){this.getTabContainer();this.getTabs().removeClass("active");},markTabAsSelected:function t(e){e.addClass("active"),jQuery(".related .dropdown [data-reference=\""+e.data("reference")+"\"]").addClass("active");},reloadTabContent:function e(){this.getSelectedTab().trigger("click");},getSelectedTab:function t(){var e=this.getTabContainer();return e.find(".nav li.active:not(.d-none)")},getTabContainer:function e(){return jQuery("div.related")},getTabs:function a(){var e=this.getTabContainer().find("li.baseLink:not(.d-none)"),t=this.getTabContainer().find("li:not(.baseLink)");return t.each(function(){var t=jQuery(this),a=t.data("iteration"),d=t.hasClass("mainNav")?"mainNav":"relatedNav";null!=a&&1>e.filter("."+d+"[data-iteration=\""+a+"\"]").length&&e.push(t.get(0));}),e},getContentHolder:function e(){return !1==this.detailViewContentHolder&&(this.detailViewContentHolder=jQuery("div.details div.contents")),this.detailViewContentHolder},getForm:function e(){return !1==this.detailViewForm&&(this.detailViewForm=jQuery("#detailView")),this.detailViewForm},getRecordId:function e(){return app.getRecordId()},getRelatedModuleName:function e(){if(1==jQuery(".relatedModuleName",this.getContentHolder()).length)return jQuery(".relatedModuleName",this.getContentHolder()).val()},saveFieldValues:function i(e){var t=jQuery.Deferred(),a=this.getRecordId(),d={};"undefined"!=typeof e&&(d=e),d.record=a,d.module=app.getModuleName(),d.action="SaveAjax";var n={};return n.data=d,n.async=!1,n.dataType="json",AppConnector.request(n).done(function(e){t.resolve(e);}),t.promise()},getRelatedListCurrentPageNum:function e(){return jQuery("input[name=\"currentPageNum\"]",this.getContentHolder()).val()},removeCommentBlockIfExists:function a(){var e=this.getContentHolder(),t=jQuery(".commentsBody",e);jQuery(".addCommentBlock",t).remove();},getCommentThread:function a(e){var t=jQuery.Deferred();return AppConnector.request(e).done(function(e){t.resolve(e);}).fail(function(){}),t.promise()},saveCommentAjax:function g(e,t,a,d,n,i,o){var r=this,l=jQuery.progressIndicator({}),s=e.closest(".singleComment"),c=s.find(".related_to").val();c||(c=r.getRecordId());var m={commentcontent:a,related_to:c,module:"ModComments"};"edit"==t?(m.record=n,m.reasontoedit=d,m.parent_comments=i,m.mode="edit",m.action="Save"):"add"==t&&(m.parent_comments=n,m.action="SaveAjax"),AppConnector.request(m).done(function(e){l.progressIndicator({mode:"hide"}),"add"==t&&r.addRelationBetweenRecords("ModComments",e.result.id,r.getTabByLabel(r.detailViewRecentCommentsTabLabel)),app.event.trigger("DetailView.SaveComment.AfterAjax",s,m,e),o.resolve(e);}).fail(function(t,a){l.progressIndicator({mode:"hide"}),e.removeAttr("disabled"),o.reject(t,a);});},saveComment:function f(t){var e,a=this,d=jQuery.Deferred(),n=jQuery(t.currentTarget),i=n.data("mode"),o=n.closest(".addCommentBlock"),r=o.find(".commentcontent"),l=r.val();if(""==l)return e=app.vtranslate("JS_LBL_COMMENT_VALUE_CANT_BE_EMPTY"),r.validationEngine("showPrompt",e,"error","bottomLeft",!0),d.reject(e),d.promise();if("edit"==i)var s=o.find("[name=\"reasonToEdit\"]").val();var c=jQuery(t.currentTarget),m=o.closest(".commentDetails").find(".commentInfoHeader"),g=m.data("commentid"),u=m.data("parentcommentid");return a.saveCommentAjax(c,i,l,s,g,u,d),d.promise()},getCommentUI:function a(e){var t=jQuery.Deferred();return AppConnector.request({view:"DetailAjax",module:"ModComments",record:e}).done(function(e){t.resolve(e);}).fail(function(){}),t.promise()},getCommentBlock:function a(){var e=this.getContentHolder(),t=jQuery(".basicAddCommentBlock",e).clone(!0,!0).removeClass("basicAddCommentBlock d-none").addClass("addCommentBlock");return t.find(".commentcontenthidden").removeClass("commentcontenthidden").addClass("commentcontent"),t},getEditCommentBlock:function a(){var e=this.getContentHolder(),t=jQuery(".basicEditCommentBlock",e).clone(!0,!0).removeClass("basicEditCommentBlock d-none").addClass("addCommentBlock");return t.find(".commentcontenthidden").removeClass("commentcontenthidden").addClass("commentcontent"),t},registerSendSmsSubmitEvent:function e(){var t=this;jQuery("body").on("submit","#massSave",function(a){var e=jQuery(a.currentTarget),d=e.find("#message").val().length;if(160<d){var n={title:app.vtranslate("JS_MESSAGE"),text:app.vtranslate("LBL_SMS_MAX_CHARACTERS_ALLOWED"),type:"error"};return Vtiger_Helper_Js.showPnotify(n),!1}var i=e.find(":submit");i.attr("disabled","disabled"),t.SendSmsSave(e),a.preventDefault();});},SendSmsSave:function d(e){var t=jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0}}),a=e.serializeFormData();AppConnector.request(a).done(function(){app.hideModalWindow(),t.progressIndicator({mode:"hide"});}).fail(function(){});},registerNameAjaxEditEvent:function a(){var e=this,t=e.getContentHolder();t.on(e.fieldUpdatedEvent,".nameField",function(){var a=e.getForm(),d=a.data("nameFields"),n="";for(var i in d){0!=i&&(n+=" ");var o=d[i];n+=a.find("[name=\""+o+"\"]").val();}var r=t.closest(".contentsDiv").find(".recordLabel");r.text(n);});},updateHeaderNameFields:function g(){var e=this,t=e.getContentHolder(),a=e.getForm(),d=a.data("nameFields"),n=t.closest(".contentsDiv").find(".recordLabel"),i="";for(var o in d){var r=d[o],l=a.find("[name=\""+r+"\"]");if(0<l.length){var s=l.val();i+=s+" ",n.find("[class=\""+r+"\"]").text(s);}}var c=n.find(".salutation");if(0<c.length){var m=c.text();i=m+i;}n.attr("title",i);},registerAjaxEditEvent:function a(){var t=this,e=t.getContentHolder();e.on(t.fieldUpdatedEvent,"input,select,textarea",function(a){t.updateHeaderValues(jQuery(a.currentTarget));});},updateHeaderValues:function r(e){var t=this;if(e.hasClass("nameField"))return t.updateHeaderNameFields(),!0;var a=e.attr("name"),d=this.getUpdatefFieldsArray(),n=t.getContentHolder();if("-1"!=jQuery.inArray(a,d)){var i=e.val(),o=n.closest(".contentsDiv").find("."+a+"_label");o.text(i);}},registerEmailFieldClickEvent:function t(){var e=this.getContentHolder();e.on("click",".emailField",function(t){t.stopPropagation();});},registerPhoneFieldClickEvent:function t(){var e=this.getContentHolder();e.on("click",".phoneField",function(t){t.stopPropagation();});},registerUrlFieldClickEvent:function t(){var e=this.getContentHolder();e.on("click",".urlField",function(t){t.stopPropagation();});},registerRelatedRowClickEvent:function t(){var e=this.getContentHolder();e.on("click",".listViewEntries",function(t){var e=jQuery(t.target,jQuery(t.currentTarget));if(!(e.is("td:first-child")&&0<e.children("input[type=\"checkbox\"]").length)&&!jQuery(t.target).is("input[type=\"checkbox\"]")){var a=jQuery(t.currentTarget),d=a.data("recordurl");"undefined"!=typeof d&&(window.location.href=d);}});},loadRelatedList:function d(e){var t=jQuery.Deferred();null==e&&(e={});var a=Vtiger_RelatedList_Js.getInstance(this.getRecordId(),app.getModuleName(),this.getSelectedTab(),this.getRelatedModuleName());return a.loadRelatedList(e).done(function(e){t.resolve(e);},function(e,a){t.reject(e,a);}),t.promise()},registerEventForRelatedList:function n(){var e=this,t=this.getContentHolder(),a=e.getRelatedModuleName();if(a){var d=Vtiger_RelatedList_Js.getInstance(e.getRecordId(),app.getModuleName(),e.getSelectedTab(),a);d.setRelatedContainer(t),d.registerRelatedEvents();}t.find(".detailViewBlockLink").each(function(t,a){a=$(a);var d=a.find(".blockContent");d.is(":visible")&&AppConnector.request({type:"GET",dataType:"html",data:a.data("url")}).done(function(t){d.html(t);var n=Vtiger_RelatedList_Js.getInstance(e.getRecordId(),app.getModuleName(),e.getSelectedTab(),a.data("reference"));n.setRelatedContainer(d),n.registerRelatedEvents();});}),t.find(".detailViewBlockLink .blockHeader").on("click",function(){var t=$(this).closest(".js-toggle-panel"),a=t.find(".blockContent"),d=a.is(":empty");a.is(":visible")||(a.progressIndicator(),AppConnector.request({type:"GET",dataType:"html",data:t.data("url")}).done(function(n){a.html(n);var i=Vtiger_RelatedList_Js.getInstance(e.getRecordId(),app.getModuleName(),e.getSelectedTab(),t.data("reference"));i.setRelatedContainer(a),d?i.registerRelatedEvents():i.registerPostLoadEvents();}));});},registerBlockAnimationEvent:function a(){var e=this,t=this.getContentHolder();t.find(".blockHeader").on("click",function(){var t=$(this).find(".js-block-toggle").not(".d-none"),a=t.data("id"),d=t.closest(".js-toggle-panel"),n=d.find(".blockContent"),i=t.data(),o=app.getModuleName();"show"===i.mode?(n.addClass("d-none"),app.cacheSet(o+"."+a,0),t.addClass("d-none"),d.find("[data-mode=\"hide\"]").removeClass("d-none")):(n.removeClass("d-none"),app.cacheSet(o+"."+a,1),t.addClass("d-none"),d.find("[data-mode=\"show\"]").removeClass("d-none")),app.event.trigger("DetailView.js-block-toggle.PostLoad",n,i,e);});},registerBlockStatusCheckOnLoad:function a(){var e=this.getContentHolder().find(".blockHeader"),t=app.getModuleName();e.each(function(e,a){var d=jQuery(a),n=d.find(".js-block-toggle").not(".d-none"),i=d.closest(".js-toggle-panel").find(".blockContent"),o=n.data("id"),r=app.cacheGet(t+"."+o,null);null!=r&&(1==r?(n.addClass("d-none"),d.find("[data-mode='show']").removeClass("d-none"),i.removeClass("d-none")):(n.addClass("d-none"),d.find("[data-mode='hide']").removeClass("d-none"),i.addClass("d-none")));});},ajaxEditHandling:function r(t){var a=this,e=jQuery(".setReadRecord");e.prop("disabled",!0);var d=jQuery(".value",t),n=jQuery(".edit",t),i=jQuery(".js-detail-quick-edit",t),o=jQuery(".fieldname",n);jQuery(o).each(function(o,r){var l=jQuery(r).val(),s=jQuery(r),c=-1==jQuery.inArray(s.data("type"),["taxes","sharedOwner","multipicklist"])?l:l+"[]",m=jQuery("[name=\""+c+"\"]",n);if("disabled"!=m.attr("disabled")&&!(0>=n.length)&&!n.is(":visible")){m.attr("data-inputmask")&&m.inputmask(),d.addClass("d-none"),i.addClass("d-none"),n.removeClass("d-none").children().filter("input[type!=\"hidden\"]input[type!=\"image\"],select").filter(":first").focus();var g=function(o){function r(e){return void 0===e||null===e?"":e+""}a.registerNameAjaxEditEvent();var g=jQuery(o.target);if(!g.closest(".fieldValue").is(t)){t.removeAttr("tabindex");var u=s.data("prevValue"),f=a.getForm(),v=f.serializeFormData(),p=v[l]?v[l]:v[c],C=p,h=Vtiger_Field_Js.getInstance(m.data("fieldinfo")),w=[],k=!1;if(2==n.find("[data-fieldinfo]").length&&n.find("[data-fieldinfo]").each(function(){var e=[];e.name=jQuery(this).attr("name"),e.type=jQuery(this).data("fieldinfo").type,"datetime"==e.type&&(k=!0),w.push(e);}),m.is("input:checkbox")&&(p=m.is(":checked")?"1":"0",m=m.filter("[type=\"checkbox\"]")),m.validationEngine("validate"))return void(m.attr("data-inputmask")&&m.inputmask());if(m.validationEngine("hide"),r(u)===r(p))n.addClass("d-none"),d.removeClass("d-none"),i.removeClass("d-none"),e.prop("disabled",!1),n.off("clickoutside");else{var b=jQuery.Event(a.fieldPreSave);if(m.trigger(b,{fieldValue:C,recordId:a.getRecordId()}),b.isDefaultPrevented())return void e.prop("disabled",!1);t.progressIndicator(),n.addClass("d-none");var T={};T.value=C,T.field=l,T=a.getCustomFieldNameValueMap(T),a.saveFieldValues(T).done(function(n){e.prop("disabled",!1);var o=n.result;t.progressIndicator({mode:"hide"}),d.removeClass("d-none"),i.removeClass("d-none");var r=o[l].display_value;if(w.length&&k&&(r=o[w[0].name].display_value+" "+o[w[1].name].display_value),d.html(r),!1==o.isEditable){jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0}});window.location.reload();}m.trigger(a.fieldUpdatedEvent,{old:u,new:C}),s.data("prevValue",p),m.data("selectedValue",p),a.targetPicklistChange&&(0<jQuery(".js-widget-general-info",a.getForm()).length?a.targetPicklist.find(".js-detail-quick-edit").trigger("click"):a.targetPicklist.trigger("click"),a.targetPicklistChange=!1,a.targetPicklist=!1);var c=a.getSelectedTab();if(c.data("linkKey")==a.detailViewSummaryTabLabel){var g=a.getContentHolder();a.reloadTabContent(),a.registerSummaryViewContainerEvents(g),a.registerEventForPicklistDependencySetup(a.getForm()),a.registerEventForRelatedList();}else c.data("linkKey")==a.detailViewDetailsTabLabel&&a.registerEventForPicklistDependencySetup(a.getForm());a.updateRecordsPDFTemplateBtn(a.getForm());}).fail(function(){n.addClass("d-none"),d.removeClass("d-none"),i.removeClass("d-none"),n.off("clickoutside"),e.prop("disabled",!1),t.progressIndicator({mode:"hide"});});}}};n.on("clickoutside",g);}});},triggerDisplayTypeEvent:function a(){var e=app.cacheGet("widthType","narrowWidthType");if(e){var t=jQuery("#detailView").find("td");t.addClass(e);}},addElementsToQuickCreateForCreatingRelation:function a(e,t){jQuery("<input type=\"hidden\" name=\"relationOperation\" value=\"true\" >").appendTo(e),jQuery.each(t,function(t,a){jQuery("<input type=\"hidden\" name=\""+t+"\" value=\""+a+"\" >").appendTo(e);});},registerEventForActivityWidget:function e(){var t=this;jQuery(".createActivity").on("click",function(a){var e=t.getRecordId(),d=app.getModuleName(),n=jQuery(a.currentTarget),i={};if(i.sourceModule=d,i.sourceRecord=e,""!=d&&!0&&"undefined"!=typeof t.referenceFieldNames.Calendar&&"undefined"!=typeof t.referenceFieldNames.Calendar[d]){var o=t.referenceFieldNames.Calendar[d];i[o]=e;}var r=n.data("url"),l={};l.callbackPostShown=function l(e){t.addElementsToQuickCreateForCreatingRelation(e,i);var a=e.find("[class^=\"CalendarQuikcCreateContents\"]").find("#goToFullForm"),d=e.find("[class^=\"EventsQuikcCreateContents\"]").find("#goToFullForm"),n=a.data("edit-view-url")+"&"+r,o=d.data("edit-view-url")+"&"+r;a.data("editViewUrl",n),d.data("editViewUrl",o);},l.callbackFunction=function i(){var e=n.closest(".js-detail-widget"),a=e.find(".widgetContentBlock"),d=a.data("url");AppConnector.request({type:"GET",dataType:"html",data:d}).done(function(t){var a=e.find(".js-detail-widget-content");a.html(t),App.Fields.Picklist.changeSelectElementView(a);}),t.loadWidgets();},l.data=Object.assign({},i),l.noCache=!1,Vtiger_Header_Js.getInstance().quickCreateModule("Calendar",l);});},getEndDate:function n(e){var t=e.split("-"),a=new Date(t[0],t[1],t[2]),d=new Date;return d.setDate(a.getDate()+2),app.getStringDate(d)},getSingleEventType:function c(e,t,a){var d=jQuery("[name=\"date_start\"]"),n=jQuery(d).val(),o=jQuery(d).data("date-format"),i=Vtiger_Helper_Js.convertToDateString(n,o,e,a),r=jQuery.extend({},["#b6a996,black"]),s={module:"Calendar",action:"Feed",start:i,end:this.getEndDate(i),type:a,mapping:r};AppConnector.request(s).done(function(a){var d=Vtiger_Helper_Js.convertToDateString(n,o,e);if(!jQuery.isEmptyObject(a))if("Task"===a[0].activitytype)for(var r in a)-1<a[r].start.indexOf(d)&&jQuery("#"+t+" .table").append("<tr><td><a target=\"_blank\" href=\""+a[r].url+"\">"+a[r].title+"</a></td></tr>");else for(var l=0;l<a[0].length;l++)-1<a[0][l].start.indexOf(d)&&jQuery("#"+t+" .table").append("<tr><td><a target=\"_blank\" href=\""+a[0][l].url+"\">"+a[0][l].title+"</a></td></tr>");});},registerFilterForAddingModuleRelatedRecordFromSummaryWidget:function e(){var t=this;jQuery(".createRecordFromFilter").on("click",function(a){var e=jQuery(a.currentTarget),d=e.closest(".js-detail-widget"),n=d.find(".js-detail-widget-content"),i=n.find("[name=\"relatedModule\"]").val(),o=e.data("url"),r=t.getRecordId(),l={},s=e.data("prf"),c=e.data("acf"),m=e.closest(".js-detail-widget-header").find("[name=\"relatedModule\"]").val(),g={};"undefined"!=typeof s&&(g[s]=r),"undefined"!=typeof c&&$.each(c,function(e,t){g[e]=t;}),0<Object.keys(g).length&&(l.data=g),l.noCache=!0,l.callbackFunction=function d(a){t.postSummaryWidgetAddRecord(a,e),"ProjectTask"==i&&t.loadModuleSummary();};var u=jQuery.progressIndicator(),f=void 0;f=window===window.parent?Vtiger_Header_Js.getInstance():window.parent.Vtiger_Header_Js.getInstance(),f.getQuickCreateForm(o,m,l).done(function(e){f.handleQuickCreateData(e,l),u.progressIndicator({mode:"hide"});});}),$(".js-detail-widget button.selectRelation").on("click",function(a){var e=jQuery(a.currentTarget).closest(".js-detail-widget"),d=e.find(".js-detail-widget-content [name=\"relatedModule\"]").val(),n=$(this).data("rf"),i={module:d,src_module:app.getModuleName(),src_record:t.getRecordId(),multi_select:!0};n&&0<Object.keys(n).length&&(i.search_key=n.key,i.search_value=n.name),app.showRecordsList(i,function(a,n){n.setSelectEvent(function(a){t.addRelationBetweenRecords(d,Object.keys(a)).done(function(){t.loadWidget(e.find(".widgetContentBlock"));});});});});},registerAddingInventoryRecords:function e(){jQuery(".createInventoryRecordFromFilter").on("click",function(t){var e=jQuery(t.currentTarget),a=e.data("url"),d=e.data("acf"),n="";"undefined"!=typeof d&&$.each(d,function(e,t){n="&"+e+"="+t,a=a.concat(n);}),window.location.href=a;});},registerEmailEvent:function e(){this.getContentHolder().find(".resetRelationsEmail").on("click",function(t){jQuery(t.currentTarget);Vtiger_Helper_Js.showConfirmationBox({message:app.vtranslate("JS_EMAIL_RESET_RELATIONS_CONFIRMATION")}).done(function(){AppConnector.request({module:"OSSMailView",action:"Relation",moduleName:app.getModuleName(),record:app.getRecordId()}).done(function(e){Vtiger_Helper_Js.showMessage({text:e.result});});});});},getFiltersDataAndLoad:function d(t,e){var a=this.getFiltersData(t,e);this.loadWidget(a.container,a.params);},getFiltersData:function s(t,e){if(t.currentTarget)var a=jQuery(t.currentTarget);else a=t;var d=a.closest(".js-detail-widget"),n=d.find(".widgetContentBlock"),i="&"+n.data("url"),o={},r=i.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(e,t,a){o[t]=a;}),l=[];return d.find(".js-detail-widget-header .js-switch").each(function(e,t){var a="",d=jQuery(t),n=d.data("urlparams");if("radio"==d.attr("type"))d.prop("checked")&&(a="undefined"==typeof d.data("on-val")?d.data("off-val"):d.data("on-val"));else{var i=d.find("option:selected").val(),o=d.data("fieldlable"),r=d.data("filter");if(a={},i!=o)a=[[r,"e",i]];else return}n&&(n in l?l[n].push(a):l[n]=[a]);}),null!=e&&$.extend(l,e),{container:$(n),params:$.extend(o,l)}},registerChangeFilterForWidget:function e(){var t=this;jQuery(".js-switch").on("change",function(a){t.getFiltersDataAndLoad(a);});},registerChangeSwitchForWidget:function a(e){var t=this;e.find(".activityWidgetContainer").on("change",".js-switch",function(a){var e=jQuery(a.currentTarget),d=e.closest(".js-detail-widget"),n=d.find(".widgetContentBlock"),i=n.data("url");i=i.replace("&type=current","").replace("&type=history",""),i+="&type=","undefined"==typeof e.data("on-val")?"undefined"!=typeof e.data("off-val")&&(d.find(".ativitiesPagination").addClass("d-none"),i+="history",i=i.replace("&sortorder=ASC","&sortorder=DESC")):(d.find(".ativitiesPagination").removeClass("d-none"),i+="current",i=i.replace("&sortorder=DESC","&sortorder=ASC")),n.data("url",i),t.loadWidget($(n));});},registerSummaryViewContainerEvents:function e(t){var a=this;this.registerEventForActivityWidget(),this.registerChangeFilterForWidget(),this.registerChangeSwitchForWidget(t),this.registerFilterForAddingModuleRelatedRecordFromSummaryWidget(),this.registerAddingInventoryRecords(),this.registerEmailEvent();a.getForm();t.off("click").on("click",".row .js-detail-quick-edit",function(t){var e=jQuery(t.currentTarget);e.addClass("d-none");var d=e.closest(".fieldValue");a.ajaxEditHandling(d);}),t.on(a.fieldUpdatedEvent,".js-widget-general-info",function(d,e){var n=t.find("[data-type='Updates']");if(n.length){var e=a.getFiltersData(n);n.find(".btnChangesReviewedOn").parent().remove(),a.loadWidget(n,e.params);}}),t.on("click",".editDefaultStatus",function(t){var e=jQuery(t.currentTarget);e.popover("hide");var a=e.data("url");a&&"undefined"!=typeof a&&app.showModalWindow(null,a);}),t.on("click",".editDescription",function(t){var a=jQuery(t.currentTarget),d=a.closest(".activityDescription"),n=d.find(".edit"),i=d.find(".value");a.hide(),i.addClass("d-none"),n.removeClass("d-none").show();var o=jQuery(".fieldname",n),r=o.val(),l=jQuery("[name=\""+r+"\"]",n),s=function(){var e=o.data("prevValue"),t=l.val(),c=l.val(),m=d.closest(".activityEntries"),g=m.find(".activityId").val(),u=m.find(".activityModule").val(),f=m.find(".activityType").val();if(e==t)n.addClass("d-none"),i.removeClass("d-none"),a.show();else{var v=l.validationEngine("validate");if(v)return void Vtiger_Helper_Js.addClickOutSideEvent(d,s);d.progressIndicator(),n.addClass("d-none"),AppConnector.request({action:"SaveAjax",record:g,field:r,value:t,module:u,activitytype:f}).done(function(){d.progressIndicator({mode:"hide"}),i.removeClass("d-none"),a.show(),i.html(c),o.data("prevValue",t);});}};l.focus(),d.one("focusout",s);}),jQuery(".changeDetailViewMode").on("click",function(){a.getTabs().filter("[data-link-key=\""+a.detailViewDetailsTabLabel+"\"]:not(.d-none)").trigger("click");}),jQuery(".createRecord").on("click",function(t){var e=jQuery(t.currentTarget),d=e.closest(".js-detail-widget"),n=d.find(".js-detail-widget-header"),i=n.find("[name=\"relatedModule\"]").val(),o=a.getRecordId(),r=app.getModuleName(),l={};if(l.sourceModule=r,l.sourceRecord=o,""!=r&&""!=i&&"undefined"!=typeof a.referenceFieldNames[i]&&"undefined"!=typeof a.referenceFieldNames[i][r]){var s=a.referenceFieldNames[i][r];l[s]=o;}var c={};c.callbackFunction=function d(t){a.postSummaryWidgetAddRecord(t,e);},c.goToFullFormcallback=function t(e){a.addElementsToQuickCreateForCreatingRelation(e,l);},c.data=l,c.noCache=!1,Vtiger_Header_Js.getInstance().quickCreateModule(i,c);}),this.registerFastEditingFiels();},addRelationBetweenRecords:function o(e,t,a){var d=jQuery.Deferred(),n=this;null==a&&(a=n.getSelectedTab());var i=Vtiger_RelatedList_Js.getInstance(n.getRecordId(),app.getModuleName(),a,e);return i.addRelations(t).done(function(e){var t=n.getContentHolder(),a=t.find("[data-type='Updates']");if(0<a.length){var i=n.getFiltersData(a);a.find(".btnChangesReviewedOn").parent().remove(),n.loadWidget(a,i.params);}d.resolve(e);}).fail(function(e,t){d.reject(e,t);}),d.promise()},postSummaryWidgetAddRecord:function r(e,t){var a=this,d=t.closest(".js-detail-widget"),n=d.find(".js-detail-widget-header"),i=n.find("[name=\"relatedModule\"]").val(),o=[];o.push(e.result._recordId),this.addRelationBetweenRecords(i,o).done(function(){a.loadWidget(d.find("[class^=\"widgetContainer_\"]"));});},registerChangeEventForModulesList:function e(){jQuery("#tagSearchModulesList").on("change",function(t){var e=jQuery(t.currentTarget);if("all"==e.val())jQuery("[name=\"tagSearchModuleResults\"]").removeClass("d-none");else{jQuery("[name=\"tagSearchModuleResults\"]").removeClass("d-none");var a=e.val();jQuery("[name=\"tagSearchModuleResults\"]").filter(":not(#"+a+")").addClass("d-none");}});},registerEventForRelatedTabClick:function d(){var e=this,t=e.getContentHolder(),a=t.closest("div.detailViewInfo");jQuery(".related",a).on("click","li",function(d,n){var i=jQuery(d.currentTarget);if(!i.hasClass("dropdown")){var o=jQuery("<div></div>");o.progressIndicator({position:"html",blockInfo:{enabled:!0,elementToBlock:a}});var r=i.data("url");if("undefined"!=typeof n){var l=n.callback;delete n.callback;}e.loadContents(r,n).done(function(a){e.deSelectAllrelatedTabs(),e.markTabAsSelected(i),Vtiger_Helper_Js.showHorizontalTopScrollBar(),o.progressIndicator({mode:"hide"}),e.registerHelpInfo(),app.registerModal(t),app.registerMoreContent(t.find("button.moreBtn")),"function"==typeof l&&l(a),i.data("linkKey")==e.detailViewSummaryTabLabel&&e.loadWidgets(),e.registerBasicEvents(),app.notifyPostAjaxReady(),app.event.trigger("DetailView.Tab.AfterLoad",a,e);}).fail(function(){o.progressIndicator({mode:"hide"});});}});},registerEventForPicklistDependencySetup:function s(e){var t=this,a=jQuery("[name=\"picklistDependency\"]",e);if(!(0>=a.length)){var d=JSON.parse(a.val()),n=Object.keys(d);if(!(0>=n.length)){for(var o=[],r=0;r<n.length;r++)o.push("[name=\""+n[r]+"\"]");o=o.join(",");var l=e.find(o);l.on("change",function(a){var n=jQuery(a.currentTarget),i=n.attr("name"),o=d[i],r=n.val(),l=o[r],s=o.__DEFAULT__;"undefined"==typeof l&&(l=s),jQuery.each(s,function(a,d){var n=l[a];"undefined"==typeof n&&(n=d);var o=jQuery("[name=\""+a+"\"]",e);if(!(0>=o.length)){var r=o.data("selectedValue");-1==jQuery.inArray(r,n)?(t.targetPicklistChange=!0,t.targetPicklist=o.closest("td")):(t.targetPicklistChange=!1,t.targetPicklist=!1);var s=o.data("availableOptions");"undefined"==typeof s&&(s=jQuery("option",o),o.data("available-options",s));var c=new jQuery,m=[];m.push("");for(var g=0;g<n.length;g++)m.push(n[g]);jQuery.each(s,function(t,a){var e=jQuery(a).val();-1!=jQuery.inArray(e,m)&&(c=c.add(jQuery(a)));});var u="";u=c.filter("[selected]").val(),1==n.length&&(u=n[0]),o.html(c).val(u).trigger("chosen:updated");}});}),l.trigger("change");}}},getChildComments:function n(e){var t=jQuery.Deferred(),a="module="+app.getModuleName()+"&view=Detail&record="+this.getRecordId()+"&mode=showChildComments&commentid="+e,d=this.getCommentThread(a);return d.done(function(e){t.resolve(e);}),t.promise()},registerEventForTotalRecordsCount:function a(){var t=this,e=this.getContentHolder();e.on("click",".totalNumberOfRecords",function(a){var e=jQuery(a.currentTarget),d=jQuery("#totalCount").val();if(e.addClass("d-none"),e.parent().progressIndicator({}),""==d){var n=t.getSelectedTab(),i=t.getRelatedModuleName(),o=Vtiger_RelatedList_Js.getInstance(t.getRecordId(),app.getModuleName(),n,i);o.getRelatedPageCount().done(function(){t.showPagingInfo();});}else t.showPagingInfo();e.parent().progressIndicator({mode:"hide"});});},showPagingInfo:function n(){var e=jQuery("#totalCount").val(),t=jQuery(".pageNumbersText"),a=t.text(),d=parseInt(jQuery("#noOfEntries").val());0==d?jQuery(".pageNumbersText").html(""):jQuery(".pageNumbersText").html(a+" ("+e+")");},getCustomFieldNameValueMap:function t(e){return e},registerSetReadRecord:function a(e){var t=this;e.on("click",".setReadRecord",function(a){var e=jQuery(a.currentTarget);e.closest(".btn-group").addClass("d-none"),jQuery("#Accounts_detailView_fieldValue_was_read").find(".value").text(app.vtranslate("LBL_YES"));var d={module:app.getModuleName(),action:"SaveAjax",record:t.getRecordId(),field:"was_read",value:"on"};AppConnector.request(d).done(function(){var e={text:app.vtranslate("JS_SET_READ_RECORD"),title:app.vtranslate("System"),type:"info"};Vtiger_Helper_Js.showPnotify(e);var a=jQuery(".related li.active");(a.data("linkKey")==t.detailViewSummaryTabLabel||a.data("linkKey")==t.detailViewDetailsTabLabel)&&t.reloadTabContent();});});},registerFastEditingFiels:function a(){var t=this,e=jQuery(".summaryWidgetFastEditing select");e.on("change",function(a){var e=jQuery(a.currentTarget),d=e.closest(".editField"),n=jQuery.progressIndicator({message:app.vtranslate("JS_SAVE_LOADER_INFO"),position:"summaryWidgetFastEditing",blockInfo:{enabled:!0}}),i=d.data("fieldname");i=i.replace("q_","");var o=d.data("prevvalue"),r=e.val(),l=e.validationEngine("validate");if(l)return void d.progressIndicator({mode:"hide"});var s=jQuery.Event(t.fieldPreSave);e.trigger(s,{fieldValue:r,recordId:t.getRecordId()});var c={};c.value=r,c.field=i,c=t.getCustomFieldNameValueMap(c),t.saveFieldValues(c),n.progressIndicator({mode:"hide"});var m={title:app.vtranslate("JS_SAVE_NOTIFY_OK"),type:"success"};Vtiger_Helper_Js.showPnotify(m),t.reloadTabContent();});},registerHelpInfo:function t(){var e=this.getForm();app.showPopoverElementView(e.find(".js-help-info"));},registerRelatedModulesRecordCount:function n(e){var a=$(".related .nav .dropdown-menu"),d=e;d&&"undefined"!=typeof d.length||(d=$(".related .nav > .relatedNav, .related .nav > .mainNav, .detailViewBlockLink, .related .nav .dropdown-menu > .relatedNav")),d.each(function(e,t){t=$(t),"1"==t.data("count")&&AppConnector.request({module:app.getModuleName(),action:"RelationAjax",record:app.getRecordId(),relatedModule:t.data("reference"),mode:"getRelatedListPageCount",tab_label:t.data("label-key")}).done(function(e){e.success&&(0===e.result.numberOfRecords&&(e.result.numberOfRecords=""),t.find(".count").text(e.result.numberOfRecords),a.find("[data-reference=\""+t.data("reference")+"\"] .count").text(e.result.numberOfRecords));});});},addComment:function u(e,t){var a=this,d=e.data("mode"),n=e.closest(".addCommentBlock"),i=n.find(".commentcontent"),o=e.closest(".singleComment");if(i.val(""),"add"==d){var r=t.result.id,l=a.getCommentUI(r);l.done(function(e){var t=n.closest(".commentDetails"),d=a.getContentHolder(),i=jQuery(".noCommentsMsgContainer",d);if(i.remove(),0<t.length){n.remove();var r=t.find("ul");if(0>=r.length){var l=o.find(".viewThreadBlock").data("childCommentsCount");o.find(".childCommentsCount").text(l+1);var s=o.find(".commentInfoHeader").data("commentid");a.getChildComments(s).done(function(e){jQuery(e).appendTo(t),o.find(".viewThreadBlock").hide(),o.find(".hideThreadBlock").show();});}else jQuery("<ul class=\"liStyleNone\"><li class=\"commentDetails\">"+e+"</li></ul>").appendTo(t);}else jQuery("<ul class=\"liStyleNone\"><li class=\"commentDetails\">"+e+"</li></ul>").prependTo(n.closest(".contents").find(".commentsList"));o.find(".commentActionsContainer").show(),app.event.trigger("DetailView.SaveComment.AfterLoad",o,e);});}else if("edit"==d){var s=o.find(".commentModifiedTime"),c=o.find(".commentInfoContent"),m=o.find("[name=\"editStatus\"]"),g=o.find("[name=\"editReason\"]");c.html(t.result.commentcontent),g.html(t.result.reasontoedit),s.text(t.result.modifiedtime),s.attr("title",t.result.modifiedtimetitle),m.hasClass("d-none")&&m.removeClass("d-none"),""!=t.result.reasontoedit&&o.find(".editReason").removeClass("d-none"),c.show(),o.find(".commentActionsContainer").show(),n.remove(),app.event.trigger("DetailView.SaveComment.AfterUpdate",o,t);}},registerCommentEvents:function a(e){var t=this;e.on("click",".addCommentBtn",function(){t.removeCommentBlockIfExists();var e=t.getCommentBlock();e.appendTo(".commentBlock");}),e.on("click",".closeCommentBlock",function(a){var e=jQuery(a.currentTarget),d=e.closest(".singleComment");d.find(".commentActionsContainer").show(),d.find(".commentInfoContent").show(),t.removeCommentBlockIfExists();}),e.on("click",".replyComment",function(a){t.removeCommentBlockIfExists();var e=jQuery(a.currentTarget),d=e.closest(".singleComment"),n=t.getCommentBlock();d.find(".commentActionsContainer").hide(),n.appendTo(d).show();}),e.on("click",".editComment",function(a){t.removeCommentBlockIfExists();var e=jQuery(a.currentTarget),d=e.closest(".singleComment"),n=d.find(".commentInfoContent"),i=d.find("[name=\"editReason\"]"),o=t.getEditCommentBlock();o.find(".commentcontent").val(n.text()),o.find("[name=\"reasonToEdit\"]").val(i.text()),n.hide(),d.find(".commentActionsContainer").hide(),o.appendTo(d).show();}),e.on("click",".detailViewSaveComment",function(a){var d=jQuery(a.currentTarget);d.is(":disabled")||t.saveComment(a).done(function(){t.registerRelatedModulesRecordCount();var a=e.find("[data-type='Comments']");t.loadWidget(a).done(function(){d.removeAttr("disabled");});}).fail(function(e,t){d.removeAttr("disabled"),app.errorLog(e,t);});}),e.on("click",".saveComment",function(a){var e=jQuery(a.currentTarget);e.is(":disabled")||t.saveComment(a).done(function(a){var d=t.getTabByLabel(t.detailViewRecentCommentsTabLabel);t.registerRelatedModulesRecordCount(d),t.addComment(e,a),e.removeAttr("disabled");}).fail(function(t,a){e.removeAttr("disabled"),app.errorLog(t,a);});}),e.on("click",".moreRecentComments",function(){var e=t.getTabByLabel(t.detailViewRecentCommentsTabLabel);e.trigger("click");}),e.find(".commentsHierarchy").on("change",function(){var e=t.getTabByLabel(t.detailViewRecentCommentsTabLabel),a=e.data("url"),d=/&hierarchy=+([\w,]+)/;a=a.replace(d,""),$(this).val()&&(a+="&hierarchy="+$(this).val()),e.data("url",a),e.trigger("click");}),e.find(".commentSearch").on("keyup",function(){var t=$(this).val();if(t){e.find(".commentDetails").addClass("d-none");var a=e.find(".js-comment-search__value:contains("+t+")");a.each(function(){$(this).closest(".commentDetails").removeClass("d-none");}),0==a.length&&e.find(".noCommentsMsgContainer").removeClass("d-none");}else e.find(".commentDetails").removeClass("d-none"),e.find(".noCommentsMsgContainer").addClass("d-none");});},registerCommentEventsInDetail:function t(e){e.find(".hierarchyComments").on("change",function(){var t=jQuery.progressIndicator();AppConnector.request({module:app.getModuleName(),view:"Detail",mode:"showRecentComments",hierarchy:$(this).val(),record:app.getRecordId()}).done(function(a){t.progressIndicator({mode:"hide"});var d=e.find(".js-detail-widget-content");d.html(a),App.Fields.Picklist.showSelect2ElementView(d.find(".select2"));});});},registerMailPreviewWidget:function a(t){var e=this;t.on("click",".showMailBody",function(t){var e=$(t.currentTarget).closest(".row"),a=e.find(".mailBody"),d=e.find(".mailTeaser"),n=$(t.currentTarget).find("[data-fa-i2svg]");a.hasClass("d-none")?(a.removeClass("d-none"),d.addClass("d-none"),n.removeClass("fa-caret-down").addClass("fa-caret-up")):(a.addClass("d-none"),d.removeClass("d-none"),n.removeClass("fa-caret-up").addClass("fa-caret-down"));}),t.find("[name=\"mail-type\"]").on("change",function(){e.loadMailPreviewWidget(t);}),t.find("[name=\"mailFilter\"]").on("change",function(){e.loadMailPreviewWidget(t);}),t.on("click",".showMailsModal",function(a){var d=$(a.currentTarget).data("url");d+="&type="+t.find("[name=\"mail-type\"]").val(),0<t.find("[name=\"mailFilter\"]").length&&(d+="&mailFilter="+t.find("[name=\"mailFilter\"]").val());var n=jQuery.progressIndicator();app.showModalWindow("",d,function(t){n.progressIndicator({mode:"hide"}),e.registerMailPreviewWidget(t),Vtiger_Index_Js.registerMailButtons(t),t.find(".expandAllMails").click();});}),t.find(".expandAllMails").on("click",function(){t.find(".mailBody").removeClass("d-none"),t.find(".mailTeaser").addClass("d-none"),t.find(".showMailBody [data-fa-i2svg]").removeClass("fa-caret-down").addClass("fa-caret-up");}),t.find(".collapseAllMails").on("click",function(){t.find(".mailBody").addClass("d-none"),t.find(".mailTeaser").removeClass("d-none"),t.find(".showMailBody [data-fa-i2svg]").removeClass("fa-caret-up").addClass("fa-caret-down");});},loadMailPreviewWidget:function o(e){var t=this,a=e.find(".js-detail-widget-content"),d=$("#recordId").val(),n=a.progressIndicator(),i={};i.module="OSSMailView",i.view="widget",i.smodule=$("#module").val(),i.srecord=d,i.mode="showEmailsList",i.type=$("[name=\"mail-type\"]").val(),i.mailFilter=$("[name=\"mailFilter\"]").val(),AppConnector.request(i).done(function(e){a.html(e),app.event.trigger("DetailView.Widget.AfterLoad",a,"Emails",t),n.progressIndicator({mode:"hide"});});},registerEmailEvents:function t(e){Vtiger_Index_Js.registerMailButtons(e);},registerMapsEvents:function a(e){e.find("#coordinates").val();if(e.find("#coordinates").length){var t=new OpenStreetMap_Map_Js;t.registerDetailView(e);}},registerShowSummary:function e(t){t.on("click",".showSummaryRelRecord",function(a){var e=$(a.currentTarget),d=e.data("id"),n=t.find(".summaryRelRecordView"+d);t.find(".listViewEntriesTable").css("display","none"),n.show();}),t.on("click",".hideSummaryRelRecordView",function(){var e=t.find(".summaryRelRecordView");t.find(".listViewEntriesTable").css("display","table"),e.hide();});},registerBasicEvents:function d(){var t=this,e=t.getContentHolder(),a=t.getSelectedTab();t.registerSummaryViewContainerEvents(e),t.registerCommentEvents(e),t.registerEmailEvents(e),t.registerMapsEvents(e),App.Fields.Date.register(e),App.Fields.DateTime.register(e),App.Fields.MultiImage.register(e),app.registerEventForClockPicker(),App.Fields.Picklist.showSelect2ElementView(e.find("select.select2")),e.on("click","#detailViewNextRecordButton",function(){var e=a.data("url"),d=t.getRelatedListCurrentPageNum(),n=parseInt(d)+1;t.loadContents(e+"&page="+n);}),e.on("click","#detailViewPreviousRecordButton",function(){var e=a.data("url"),d=t.getRelatedListCurrentPageNum(),n=parseInt(d)-1;t.loadContents(e+"&page="+n);}),e.on("click","div.detailViewTable div.fieldValue",function(a){if(!jQuery(a.target).closest("a").hasClass("btnNoFastEdit")){var e=jQuery(a.currentTarget);t.ajaxEditHandling(e);}}),e.on("click","div.recordDetails span.squeezedWell",function(t){var e=jQuery(t.currentTarget),a=e.data("reference");jQuery(".detailViewInfo .related .nav > li[data-reference=\""+a+"\"]").trigger("click");}),e.on("click",".relatedPopup",function(t){var e=new Vtiger_Edit_Js;return e.showRecordsList(t),!1}),e.on("click",".viewThread",function(a){var e=jQuery(a.currentTarget),d=e.parent(),n=e.closest(".commentActions"),i=e.closest(".commentDetails"),o=i.find("ul");if(0<o.length)return o.show(),n.find(".hideThreadBlock").show(),void d.hide();var r=e.closest(".commentDiv").find(".commentInfoHeader").data("commentid");t.getChildComments(r).done(function(e){jQuery(e).appendTo(jQuery(a.currentTarget).closest(".commentDetails")),n.find(".hideThreadBlock").show(),d.hide();});}),e.on("click",".hideThread",function(t){var e=jQuery(t.currentTarget),a=e.parent(),d=e.closest(".commentActions"),n=e.closest(".commentDetails");n.find("ul").hide(),a.hide(),d.find(".viewThreadBlock").show();}),e.on("click",".detailViewThread",function(a){var e=t.getTabByLabel(t.detailViewRecentCommentsTabLabel),d=jQuery(a.currentTarget).closest(".singleComment").find(".commentInfoHeader").data("commentid");e.trigger("click",{commentid:d,callback:function e(){window.location.href=window.location.href+"#"+d;}});}),e.on("click",".moreRecentRecords",function(a){a.preventDefault();var e=t.getTabByModule($(this).data("label-key"));e.trigger("click");}),e.on("change",".relatedHistoryTypes",function(t){var e=jQuery(this).closest(".widgetContentBlock").find(".widgetContent"),a=jQuery(t.currentTarget).val(),d=e.find("#relatedHistoryPageLimit").val(),n=jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0,elementToBlock:e}});AppConnector.request({module:app.getModuleName(),view:"Detail",record:app.getRecordId(),mode:"showRecentRelation",page:1,limit:d,type:a}).done(function(t){n.progressIndicator({mode:"hide"}),e.find("#relatedHistoryCurrentPage").remove(),e.find("#moreRelatedUpdates").remove(),e.html(t),Vtiger_Index_Js.registerMailButtons(e);});}),e.on("click",".moreProductsService",function(){jQuery(".related .mainNav[data-reference=\"ProductsAndServices\"]:not(.d-none)").trigger("click");}),e.on("click",".moreRelatedUpdates",function(){var e=jQuery(this).closest(".widgetContentBlock"),t=e.find(".widgetContent"),a=jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0,elementToBlock:t}}),d=t.find("#relatedHistoryCurrentPage").val(),n=parseInt(d)+1,i=e.find(".relatedHistoryTypes").val(),o=t.find("#relatedHistoryPageLimit").val();AppConnector.request({module:app.getModuleName(),view:"Detail",record:app.getRecordId(),mode:"showRecentRelation",page:n,limit:o,type:i}).done(function(e){a.progressIndicator({mode:"hide"}),t.find("#relatedHistoryCurrentPage").remove(),t.find("#moreRelatedUpdates").remove(),t.find("#relatedUpdates").append(e);});}),e.on("click",".moreRecentUpdates",function(a){var e=$(a.currentTarget).closest(".recentActivitiesContainer"),d=e.find("#newChange"),n=d.val(),i=e.find("#updatesCurrentPage").val(),o=parseInt(i)+1;if(e.closest(".js-detail-widget").length)var r=t.getFiltersData(a,{page:o,tab_label:"LBL_UPDATES",newChange:n},e.find("#updates")),l=r.params;else{var l=t.getTabByLabel(t.detailViewRecentUpdatesTabLabel).data("url");if(l=l.replace("&page=1","&page="+o)+"&skipHeader=true&newChange="+n,-1==l.indexOf("&whereCondition")){var s=jQuery(".active .js-switch--recentActivities");l+="&whereCondition="+("undefined"==typeof s.data("on-val")?s.data("off-val"):s.data("on-val"));}}AppConnector.request(l).done(function(a){var d=jQuery(a);e.find("#newChange").val(d.find("#newChange").val()),e.find("#updatesCurrentPage").val(d.find("#updatesCurrentPage").val()),e.find(".js-more-link").html(d.find(".js-more-link").html()),e.find("#updates ul").append(d.find("#updates ul").html()),app.registerMoreContent(e.find("button.moreBtn")),app.event.trigger("DetailView.UpdatesWidget.AddMore",a,t);});}),e.on("click",".btnChangesReviewedOn",function(d){var n=jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0}}),i="index.php?module=ModTracker&action=ChangesReviewedOn&record="+app.getRecordId();AppConnector.request(i).done(function(){if(n.progressIndicator({mode:"hide"}),jQuery(d.currentTarget).parent().remove(),t.getTabByLabel(t.detailViewRecentUpdatesTabLabel).find(".count.badge").text(""),a.data("labelKey")==t.detailViewRecentUpdatesTabLabel)t.reloadTabContent();else if(a.data("linkKey")==t.detailViewSummaryTabLabel){var i=e.find("[data-type='Updates']");if(0<i.length){var o=t.getFiltersData(i);t.loadWidget(i,o.params);}}});}),e.on("click",".moreRecentDocuments",function(){var e=t.getTabByLabel(t.detailViewRecentDocumentsTabLabel);e.trigger("click");}),e.on("click",".moreRecentActivities",function(a){var e=$(a.currentTarget);e.prop("disabled",!0);var d=e.closest(".activityWidgetContainer"),n=d.find(".currentPage").val();n++;var i=d.find(".widgetContentBlock").data("url");i=i.replace("&page=1","&page="+n),i+="&totalCount="+d.find(".totaltActivities").val(),AppConnector.request(i).done(function(a){e.prop("disabled",!1),e.addClass("d-none");var n=d.find(".currentPage").val();d.find(".currentPage").remove(),d.find(".countActivities").remove(),d.find(".js-detail-widget-content").append(a),d.find(".countActivities").val(parseInt(d.find(".countActivities").val())+n*parseInt(d.find(".pageLimit").val())),t.reloadWidgetActivitesStats(d),app.showPopoverElementView(d.find(".js-popover-tooltip"));});}),e.on("click",".widgetFullscreen",function(t){var e=$(t.currentTarget),a=e.closest(".widgetContentBlock"),d=a.data("url");d=d.replace("&view=Detail&","&view=WidgetFullscreen&");var n=jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0}});app.showModalWindow(null,"index.php?"+d,function(){n.progressIndicator({mode:"hide"});});}),t.registerEventForRelatedList(),t.registerBlockAnimationEvent(),t.registerMailPreviewWidget(e.find(".widgetContentBlock[data-type=\"EmailList\"]")),t.registerMailPreviewWidget(e.find(".widgetContentBlock[data-type=\"HistoryRelation\"]")),e.find(".js-switch--recentActivities").off().on("change",function(a){var e=jQuery(a.currentTarget),d=t.getTabByLabel(t.detailViewRecentUpdatesTabLabel),n=e.data("urlparams"),i=$(this).data("on-val"),o=$(this).data("off-val"),r=d.data("url");r=r.replace("&"+n+"="+i,"").replace("&"+n+"="+o,""),"undefined"==typeof e.data("on-val")?"undefined"!=typeof e.data("off-val")&&(r+="&"+n+"="+o):r+="&"+n+"="+i,d.data("url",r),d.trigger("click");});},reloadWidgetActivitesStats:function r(e){var t=e.find(".countActivities"),a=e.find(".totaltActivities");if(!t.length||!a.length)return !1;var d=" ("+t.val()+"/"+a.val()+")",n=e.find(".active .js-switch"),i=n.parent(),o=n.data("basic-text")+d;i.removeTextNode(),i.append(o);},refreshCommentContainer:function i(e){var t=this,a=$(".commentsBody"),d={module:app.getModuleName(),view:"Detail",record:t.getRecordId(),mode:"showThreadComments",commentid:e},n=jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0,elementToBlock:a}});AppConnector.request(d).done(function(e){n.progressIndicator({mode:"hide"}),a.html(e);});},updateRecordsPDFTemplateBtn:function t(){var e={};e.data={module:app.getModuleName(),action:"PDF",mode:"hasValidTemplate",record:app.getRecordId(),view:app.getViewName()},e.dataType="json",AppConnector.request(e).done(function(e){var t=e.result,a=jQuery(".detailViewToolbar .btn-toolbar");if(!1==t.valid){var d=a.find(".btn-group:eq(1) [href*=\"showPdfModal\"]");d.length&&d.remove();}else{var n=a.find(".btn-group:eq(1)"),d=a.find(".btn-group:eq(1) [href*=\"showPdfModal\"]");0==d.length&&n.append("<a class=\"btn btn-default js-popover-tooltip\" href='javascript:Vtiger_Header_Js.getInstance().showPdfModal(\"index.php?module="+app.getModuleName()+"&view=PDF&fromview=Detail&record="+app.getRecordId()+"\");' data-content=\""+app.vtranslate("LBL_EXPORT_PDF")+"\" data-original-title=\"\" title=\"\"><span class=\"fas fa-file-excel icon-in-button\"></span></a>");}}).fail(function(e,t){app.errorLog(e,t);});},updateWindowHeight:function a(e,t){t.height(e);},registerEvents:function t(){this.registerHelpInfo(),this.registerSendSmsSubmitEvent(),this.registerAjaxEditEvent(),this.registerRelatedRowClickEvent(),this.registerBlockStatusCheckOnLoad(),this.registerEmailFieldClickEvent(),this.registerPhoneFieldClickEvent(),this.registerEventForRelatedTabClick(),Vtiger_Helper_Js.showHorizontalTopScrollBar(),this.registerUrlFieldClickEvent();var e=jQuery("div.detailViewContainer");0>=e.length||(this.registerSetReadRecord(e),this.registerEventForPicklistDependencySetup(this.getForm()),this.getForm().validationEngine(app.validationEngineOptionsForRecord),this.loadWidgetsEvents(),this.loadWidgets(),this.registerBasicEvents(),this.registerEventForTotalRecordsCount());}});
//# sourceMappingURL=Detail.min.js.map
