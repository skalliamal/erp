'use strict';

var Vtiger_Index_Js={showLocation:function b(a){app.showModalWindow(null,'index.php?module=OpenStreetMap&view=MapModal',function(b){var c=new OpenStreetMap_Map_Js;c.registerModalView(b),b.find('.searchValue').val($(a).data('location')),b.find('.searchBtn').trigger('click');});},massAddDocuments:function b(a){app.showModalWindow(null,a,function(b){var c=b.find('#filesToUpload'),d=b.find('.fileContainer'),e=b.find('.uploadFileContainer'),f=b.find('form');c.on('change',function(){e.find('.fileItem').remove();for(var a=c[0].files,b=0;b<a.length;b++)e.append(d.html()),e.find('[name="nameFile[]"]:last').val(a[b].name);}),f.on('submit',function(b){b.preventDefault();var c=new FormData(f[0]);if(c){a='index.php','Detail'===app.getViewName()&&(c.append('createmode','link'),c.append('return_module',app.getModuleName()),c.append('return_id',app.getRecordId()));var d={url:a,type:'POST',data:c,processData:!1,contentType:!1},e=$.progressIndicator({blockInfo:{enabled:!0}});AppConnector.request(d).done(function(){if(e.progressIndicator({mode:'hide'}),app.hideModalWindow(),'Detail'===app.getViewName()){var a=Vtiger_Detail_Js.getInstance();if('Documents'===a.getSelectedTab().data('reference'))a.reloadTabContent();else{var b=a.getContentHolder().find('[data-type=\'RelatedModule\'][data-name=\'Documents\']');if(0<b.length){var c=a.getFiltersData(b);a.loadWidget(b,c.params);}}}else Vtiger_List_Js.getInstance().getListViewRecords();});}});});},getEmailFromRecord:function e(a,b,c){var d=$.Deferred();return AppConnector.request({dataType:'html',data:{module:'OSSMail',action:'GetMail',sourceModule:b,sourceRecord:a,maxEmails:c}}).done(function(a){'{'==a.substring(0,1)?(a=JSON.parse(a),a=a.result,d.resolve(a)):app.showModalWindow(a,function(a){a.find('.selectButton').on('click',function(){var b=a.find('input:checked').val();app.hideModalWindow(a),d.resolve(b);});});}).fail(function(a){d.reject(a);}),d.promise()},registerMailButtons:function c(a){var b=this;a.find('.sendMailBtn:not(.mailBtnActive)').each(function(){var a=$(this);a.addClass('mailBtnActive'),a.on('click',function(c){c.stopPropagation();var d=a.data('url'),e=a.data('module'),f=a.data('record'),g=a.data('popup'),h=a.data('to');h&&(d+='&to='+h),b.sendMailWindow(d,g);});});},sendMailWindow:function i(a,b,c){if(b){var d=screen.width-15,e=screen.height-150;if(null==c)return void window.open(a,'_blank','width='+d+', height='+e+', left='+0+', top='+30+',resizable=yes,scrollbars=yes,toolbar=yes,menubar=no,location=no,status=nomenubar=no');var f=$('<form/>',{action:'index.php'}),g=a.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(a,b,c){f.append($('<input>',{name:b,value:c}));});for(var h in c)f.append($('<input>',{name:h,value:JSON.stringify(c[h])}));$('body').append(f),f.submit();}else window.location.href=a;},registerWidgetsEvents:function b(){var a=$('div.widgetContainer');a.on('shown.bs.collapse',function(a){var b=$(a.currentTarget);Vtiger_Index_Js.loadWidgets(b);var c=b.attr('id');app.cacheSet(c,1);}),a.on('hidden.bs.collapse',function(a){var b=$(a.currentTarget),c=b.parent().find('.imageElement'),d=c.data('rightimage');c.attr('src',d);var e=b.attr('id');app.cacheSet(e,0);});},loadWidgets:function g(a,b){var c=$('.loadingWidgetMsg').html();if(a.find('.card-body').html().trim()){var d=a.parent().find('.imageElement'),e=d.data('downimage');return d.attr('src',e),void a.css('height','auto')}a.progressIndicator({message:c});var f=a.data('url');AppConnector.request({type:'GET',url:'index.php',dataType:'html',data:f}).done(function(c){if('undefined'==typeof b&&(b=!0),b){a.progressIndicator({mode:'hide'});var d=a.parent().find('.imageElement'),e=d.data('downimage');d.attr('src',e),a.css('height','auto');}if(a.html(c),''==c)a.closest('.quickWidget').addClass('d-none');else var f=a.closest('.quickWidget').find('.quickWidgetHeader').data('label');$('.bodyContents').trigger('Vtiger.Widget.Load.'+f,$(a));});},loadWidgetsOnLoad:function b(){var a=$('div.widgetContainer');a.each(function(a,b){Vtiger_Index_Js.loadWidgets($(b));});},changeSkin:function a(){$('.themeElement').on('click',function(a){a.stopPropagation();var b=$(a.currentTarget);b.closest('#themeContainer').hide();var c=$('#progressDiv');c.progressIndicator();var d={module:'Users',action:'SaveAjax',record:CONFIG.userId,field:'theme',value:b.data('skinName')};AppConnector.request(d).done(function(a){a.success&&a.result&&(c.progressIndicator({mode:'hide'}),$('.settingIcons').removeClass('open'),window.location.reload());}).fail(function(){});});},markNotifications:function d(a){var b=$.Deferred(),c=this;return AppConnector.request({module:'Notification',action:'Notification',mode:'setMark',ids:a}).done(function(d){var e=$('.notificationEntries .noticeRow[data-id="'+a+'"]');Vtiger_Helper_Js.showPnotify({title:app.vtranslate('JS_MESSAGE'),text:app.vtranslate('JS_MARKED_AS_READ'),type:'info'}),e.length&&(e.fadeOut(300,function(){var a=e.closest('.notificationEntries');e.remove(),a.each(function(){var a=$(this);0==a.find('.noticeRow').length&&a.closest('.panel').hide();});}),c.getNotificationsForReminder()),b.resolve(d);}).fail(function(a,c){app.errorLog(a,c),b.reject(a,c);}),b.promise()},markAllNotifications:function d(a){var b=[],c=$(a).closest('.notificationContainer');if(c.find('.notificationEntries .noticeRow').each(function(){b.push($(this).data('id'));}),0==b.length)return a.remove(),!1;c.progressIndicator({position:'html'}),AppConnector.request({module:'Notification',action:'Notification',mode:'setMark',ids:b}).done(function(){c.progressIndicator({mode:'hide'}),Vtiger_Helper_Js.showPnotify({title:app.vtranslate('JS_MESSAGE'),text:app.vtranslate('JS_MARKED_AS_READ'),type:'info'}),Vtiger_Index_Js.getNotificationsForReminder();});},registerReminders:function c(){var a=1e3*(parseInt(app.getMainParams('activityReminder'))||0);0!=a&&$('.remindersNotice.autoRefreshing').length&&(Vtiger_Index_Js.requestReminder(),window.reminder=setInterval(function(){Vtiger_Index_Js.requestReminder();},a));var b=1e3*(parseInt(app.getMainParams('intervalForNotificationNumberCheck'))||0);0!=b&&$('.notificationsNotice.autoRefreshing').length&&(Vtiger_Index_Js.getNotificationsForReminder(),window.reminderNotifications=setInterval(function(){Vtiger_Index_Js.getNotificationsForReminder();},b));},getNotificationsForReminder:function d(){var a=this,b=$('.remindersNotificationContainer'),c=$('.notificationsNotice');AppConnector.request('index.php?module=Notification&view=Reminders').done(function(d){b.html(d),app.registerMoreContent(b.find('button.moreBtn')),a.refreshReminderCount(b,c,'js-count-notifications-reminder'),b.find('.js-set-marked').on('click',function(d){var e=$(d.currentTarget),f=e.closest('.js-notification-panel').data('record');a.markNotifications(f).done(function(){e.closest('.js-notification-panel').fadeOut(300,function(){$(this).remove(),a.refreshReminderCount(b,c,'js-count-notifications-reminder');});});});}).fail(function(){clearInterval(window.reminderNotifications);});},requestReminder:function d(){var a=this,b=$('.remindersNoticeContainer'),c=$('.remindersNotice');AppConnector.request('index.php?module=Calendar&view=Reminders&type_remainder=true').done(function(d){b.html(d),a.refreshReminderCount(b,c,'countRemindersNotice'),app.registerModal(b),b.find('.reminderPostpone').on('click',function(d){var e=$(d.currentTarget),f=e.closest('.js-toggle-panel').data('record'),g='index.php?module=Calendar&action=ActivityReminder&mode=postpone&record='+f+'&time='+e.data('time');AppConnector.request(g).done(function(){e.closest('.js-toggle-panel').fadeOut(300,function(){$(this).remove(),a.refreshReminderCount(b,c,'countRemindersNotice');});});});}).fail(function(){clearInterval(window.reminder);});},refreshReminderCount:function f(a,b,c){var d=b.find('.badge'),e=a.find('.js-toggle-panel').length;d.text(e),d.removeClass('d-none'),0<e&&b.hasClass('autoRefreshing')?(b.effect('pulsate',1500),app.cacheGet(c)!=e&&(app.playSound('REMINDERS'),app.cacheSet(c,e))):d.addClass('d-none');},registerResizeEvent:function a(){$(window).on('resize',function(){this.resizeTO&&clearTimeout(this.resizeTO),this.resizeTO=setTimeout(function(){$(this).trigger('resizeEnd');},600);});},registerTooltipEvents:function h(){function a(a){return 400>window.innerWidth-jQuery(a).offset().left||b(a)?'left':'right'}function b(a){var b=a.closest('tr'),c=b.find('td.listViewEntryValue:last a');return a.attr('href')===c.attr('href')}function c(b,c){b.popover({trigger:'manual',content:c,delay:100,animation:!1,html:!0,placement:a(b)}),g.push(b.popover('show')),e();}function d(){$.each(g,function(a,b){b.popover('hide');}),g=[];}function e(){$('button[name="vtTooltipClose"]').on('click',function(){var a=g.pop();a.popover('hide'),$('.popover').css('display','none','important');});}var f=$.unique($.merge($('.showReferenceTooltip'),$('[data-field-type="reference"] > a'),$('[data-field-type="multireference"] > a'))),g=[];f.hoverIntent({interval:100,sensitivity:7,timeout:10,over:function(){d();var a=jQuery(this),b=a.attr('href')?a.attr('href'):'';if(''!==b){b=b.replace('view=','xview=')+'&view=TooltipAjax';var e=jQuery('[data-url-cached="'+b+'"]');e&&e.length?c(a,e.html()):AppConnector.request(b).done(function(d){e=jQuery('<div>').css({display:'none'}).attr('data-url-cached',b),e.html(d),jQuery('body').append(e),c(a,d);});}},out:function(){$('.popover').on('mouseleave',function(){d();}),$(this).on('mouseleave',function(){setTimeout(function(){$('.popover:hover').length||d();},100);});}});},changeWatching:function g(a){var b,c,d,e,f;a!=null&&(a=$(a),b=a.data('value'),c=null==a.data('module')?app.getModuleName():a.data('module'),a.data('user')!=null&&(e=a.data('user')),a.data('record')!=null&&(f=a.data('record'))),bootbox.dialog({message:app.vtranslate('JS_WATCHING_MESSAGE'+b),title:'<span class="fas fa-eye mr-1"></span>'+app.vtranslate('JS_WATCHING_TITLE'),buttons:{success:{label:'<span class="fas fa-check mr-1"></span>'+app.vtranslate('LBL_YES'),className:'btn-success',callback:function g(){Vtiger_Index_Js.updateWatching(c,b,e,f).done(function(b){if(a!=null){var c=a.find('[data-fa-i2svg]');d=1==b.result?0:1,a.data('value',d),1==d?(a.toggleClass(a.data('off')+' '+a.data('on')),c.addClass('fa-eye-slash'),c.removeClass('fas fa-eye')):(a.toggleClass(a.data('on')+' '+a.data('off')),c.addClass('fas fa-eye'),c.removeClass('fa-eye-slash'));}});}},danger:{label:'<span class="fas fa-times mr-1"></span>'+app.vtranslate('LBL_NO'),className:'btn-danger',callback:function a(){}}}});},updateWatching:function g(a,b,c,d){var e=$.Deferred(),f={module:a,action:'Watchdog',state:b};return null!=c&&(f.user=c),null!=d&&0!=d&&(f.record=d),AppConnector.request(f).done(function(a){e.resolve(a);}).fail(function(a,b){e.reject(a,b),app.errorLog(a,b);}),e.promise()},assignToOwner:function d(a,b){$.Deferred();a=$(a),b==null&&(b=CONFIG.userId);var c={module:a.data('module'),record:a.data('record'),field:'assigned_user_id',value:b};app.saveAjax('',null,c).done(function(){if(app.hideModalWindow(),'List'===app.getViewName()){var a=new Vtiger_List_Js;a.getListViewRecords();}});},sendNotification:function a(){Vtiger_Header_Js.getInstance().quickCreateModule('Notification');},performPhoneCall:function c(a,b){AppConnector.request({module:app.getModuleName(),view:'BasicAjax',mode:'performPhoneCall',phoneNumber:a,record:b}).done(function(a){a=JSON.parse(a),Vtiger_Helper_Js.showMessage({text:a.result});});},registerAterloginEvents:function a(){'undefined'!=typeof CONFIG.ShowUserPasswordChange&&app.showModalWindow(null,'index.php?module=Users&view=PasswordModal&mode=change&record='+CONFIG.userId),'undefined'!=typeof CONFIG.ShowAuthy2faModal&&app.showModalWindow({backdrop:'static',url:'index.php?module=Users&view=TwoFactorAuthenticationModal&record='+CONFIG.userId});},registerEvents:function a(){Vtiger_Index_Js.registerWidgetsEvents(),Vtiger_Index_Js.loadWidgetsOnLoad(),Vtiger_Index_Js.registerReminders(),Vtiger_Index_Js.registerTooltipEvents(),Vtiger_Index_Js.changeSkin(),Vtiger_Index_Js.registerResizeEvent(),Vtiger_Index_Js.registerAterloginEvents();},registerPostAjaxEvents:function a(){Vtiger_Index_Js.registerTooltipEvents();}};$(document).ready(function(){Vtiger_Index_Js.registerEvents(),app.listenPostAjaxReady(function(){Vtiger_Index_Js.registerPostAjaxEvents();});});
//# sourceMappingURL=Vtiger.min.js.map
